# راهنمای استفاده از APIهای MobixAI

## بررسی اجمالی

این سند نحوه استفاده از APIهای جدید Django REST Framework (DRF) برای پروژه MobixAI را توضیح می‌دهد. APIها وظایف مشابهی با نماهای موجود Django انجام می‌دهند اما به صورت RESTful و قابل استفاده برای برنامه‌های خارجی طراحی شده‌اند.

## پیش‌نیازها

1. نصب Django REST Framework:
   ```bash
   pip install djangorestframework
   ```

2. تغییرات پیکربندی که قبلاً اعمال شده‌اند:
   - افزودن `rest_framework` و `api` به `INSTALLED_APPS` در `settings.py`
   - افزودن پیکربندی DRF به `settings.py`
   - افزودن `djangorestframework>=3.14.0` به `requirements.txt`
   - افزودن الگوی URL `/api/` به `urls.py` اصلی

## احراز هویت

تمامی APIها نیاز به احراز هویت از طریق احراز هویت جلسه‌ای دارند. کاربران باید برای دسترسی به APIها وارد سیستم شده باشند.

برای برنامه‌های خارجی (مانند ربات‌های تلگرام یا اپلیکیشن‌های موبایل)، باید یک فرآیند ورود پیاده‌سازی کنید:
1. ارسال درخواست POST به نقطه پایانی ورود موجود با اطلاعات کاربر
2. ذخیره کوکی‌های جلسه از پاسخ
3. گنجاندن آن کوکی‌ها در تمامی درخواست‌های بعدی

## نقاط پایانی موجود

### URL پایه
تمامی نقاط پایانی با پیشوند `/api/` شروع می‌شوند

### کاربران
- `GET /api/users/` - دریافت اطلاعات کاربر فعلی
- `GET /api/users/subscription/` - دریافت اطلاعات اشتراک کاربر

### چت‌بات‌ها
- `GET /api/chatbots/` - لیست چت‌بات‌های موجود برای کاربر فعلی

### مدل‌های هوش مصنوعی
- `GET /api/ai-models/` - لیست مدل‌های هوش مصنوعی موجود برای کاربر فعلی

### جلسات چت
- `GET /api/chat-sessions/` - لیست جلسات چت کاربر
- `POST /api/chat-sessions/` - ایجاد جلسه چت جدید
- `GET /api/chat-sessions/{id}/` - دریافت جلسه چت خاص
- `PUT /api/chat-sessions/{id}/` - به‌روزرسانی جلسه چت
- `DELETE /api/chat-sessions/{id}/` - حذف جلسه چت
- `GET /api/chat-sessions/{id}/messages/` - دریافت پیام‌های جلسه
- `POST /api/chat-sessions/{id}/send/` - ارسال پیام به جلسه چت
- `POST /api/chat-sessions/{id}/update-title/` - به‌روزرسانی عنوان جلسه
- `POST /api/chat-sessions/{id}/messages/{message_id}/edit/` - ویرایش پیام

### استفاده از جلسات چت
- `GET /api/chat-session-usages/` - لیست رکوردهای استفاده از جلسات چت

## نمونه‌های استفاده

### 1. دریافت اطلاعات کاربر
```bash
curl -X GET http://localhost:8000/api/users/ \
  -H "Content-Type: application/json" \
  -b "sessionid=your_session_id;csrftoken=your_csrf_token"
```

### 2. لیست چت‌بات‌های موجود
```bash
curl -X GET http://localhost:8000/api/chatbots/ \
  -H "Content-Type: application/json" \
  -b "sessionid=your_session_id;csrftoken=your_csrf_token"
```

### 3. ایجاد جلسه چت جدید
```bash
curl -X POST http://localhost:8000/api/chat-sessions/ \
  -H "Content-Type: application/json" \
  -H "X-CSRFToken: your_csrf_token" \
  -b "sessionid=your_session_id;csrftoken=your_csrf_token" \
  -d '{
    "chatbot_id": 1,
    "ai_model_id": "openai/gpt-4",
    "title": "چت جدید"
  }'
```

### 4. ارسال پیام به جلسه چت
```bash
curl -X POST http://localhost:8000/api/chat-sessions/1/send/ \
  -H "Content-Type: application/json" \
  -H "X-CSRFToken: your_csrf_token" \
  -b "sessionid=your_session_id;csrftoken=your_csrf_token" \
  -d '{
    "message": "سلام، حالتان چطور است؟"
  }'
```

## سازگاری منطق تجاری

پیاده‌سازی API دقیقاً با نماهای موجود Django سازگار است:

1. **احراز هویت کاربر**: استفاده از مدل CustomUser با phone_number به عنوان USERNAME_FIELD
2. **مدیریت اشتراک**: احترام به کنترل دسترسی مبتنی بر اشتراک
3. **محدودیت‌های استفاده**: اجرای تمامی بررسی‌های محدودیت استفاده به همان صورت موجود:
   - محدودیت‌های زمانی (ساعتی، روزانه، هفتگی، ماهانه)
   - شمارش توکن و محدودیت‌ها
   - ردیابی استفاده از مدل‌های رایگان
   - محدودیت‌های تولید تصویر
4. **دسترسی به مدل هوش مصنوعی**: کنترل دسترسی از طریق روابط ModelSubscription و UserSubscription
5. **مدیریت پیام**: پیگیری منطقی یکسان برای ایجاد پیام، ویرایش و شمارش توکن
6. **مدیریت جلسه چت**: کارکرد دقیقاً مشابه با ایجاد جلسه موجود، تولید عنوان و مدیریت پیام

## تست API

شما می‌توانید از اسکریپت‌های تست ارائه شده استفاده کنید:

1. `simple_api_test.py` - تست اینکه کامپوننت‌های API به درستی قابل وارد کردن هستند
2. `test_api.py` - تست‌های جامع‌تر (نیاز به محیط تست Django کارآمد)

برای اجرای تست ساده:
```bash
python simple_api_test.py
```

## ادغام با برنامه‌های خارجی

### برای ربات‌های تلگرام
1. پیاده‌سازی فرآیند ورود برای دریافت کوکی‌های جلسه
2. ذخیره ایمن کوکی‌های جلسه
3. استفاده از نقاط پایانی API برای ایجاد جلسات، ارسال پیام و دریافت پاسخ‌ها

### برای اپلیکیشن‌های موبایل
1. پیاده‌سازی فرآیند ورود برای دریافت کوکی‌های جلسه
2. ذخیره ایمن کوکی‌های جلسه
3. استفاده از نقاط پایانی API برای فراهم کردن قابلیت چت در اپلیکیشن شما

### برای برنامه‌های وب
1. استفاده از احراز هویت جلسه‌ای Django موجود
2. ایجاد درخواست‌های AJAX به نقاط پایانی API
3. مدیریت پاسخ‌ها در کد فرانت‌اند

## مدیریت خطا

API کدهای استاندارد وضعیت HTTP را برمی‌گرداند:
- 200: موفقیت
- 201: ایجاد شد (برای درخواست‌های POST که منابع ایجاد می‌کنند)
- 400: درخواست بد (ورودی نامعتبر)
- 401: غیرمجاز (وارد نشده‌اید)
- 403: ممنوع (مجوز کافی ندارید)
- 404: یافت نشد (منبع وجود ندارد)
- 500: خطای داخلی سرور (خطای غیرمنتظره)

پاسخ‌های خطا شامل یک شی JSON با پیام خطا هستند:
```json
{
  "error": "پیام خطای دقیق"
}
```

## پشتیبانی از صفحه‌بندی

نقاط پایانی لیست از صفحه‌بندی پشتیبانی می‌کنند:
- `GET /api/chat-sessions/?page=1&page_size=20`

پاسخ شامل اطلاعات صفحه‌بندی است:
```json
{
  "count": 100,
  "next": "http://localhost:8000/api/chat-sessions/?page=2&page_size=20",
  "previous": null,
  "results": [
    // ... آرایه‌ای از اشیاء
  ]
}
```

## نتیجه‌گیری

API MobixAI یک رابط تمیز و RESTful برای تمامی قابلیت‌های برنامه فراهم می‌کند و در عین حال سازگاری کامل با منطق تجاری موجود را حفظ می‌کند. این API می‌تواند برای ساخت انواع مختلفی از برنامه‌ها که نیاز به تعامل با پلتفرم MobixAI دارند، استفاده شود.