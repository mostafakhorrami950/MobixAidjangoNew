# اتصال به درگاه پرداخت زیبال

این مستندات نحوه اتصال به درگاه پرداخت زیبال در پروژه را توضیح می‌دهد.

## تنظیمات اولیه

برای استفاده از درگاه پرداخت زیبال، باید تنظیمات زیر را در فایل `.env` خود اضافه کنید:

```
ZIBAL_MERCHANT_ID=merchant_id_شما
```

برای تست می‌توانید از مقدار `zibal` به عنوان merchant_id استفاده کنید.

## نحوه کار درگاه پرداخت

درگاه پرداخت زیبال 4 مرحله اصلی دارد:

### 1. درخواست پرداخت (Request)
برای ایجاد یک پرداخت جدید، اطلاعات سفارش به زیبال ارسال می‌شود و یک `trackId` دریافت می‌کنید.

### 2. شروع پرداخت (Start)
با ارسال `trackId` به آدرس `https://gateway.zibal.ir/start/{trackId}` کاربر به صفحه پرداخت هدایت می‌شود.

### 3. تایید پرداخت (Verify)
پس از بازگشت کاربر از درگاه پرداخت، باید پرداخت را با استفاده از `trackId` تایید کنید.

### 4. استعلام پرداخت (Inquiry)
در صورت نیاز می‌توانید وضعیت یک پرداخت را با استفاده از `trackId` استعلام کنید.

## کلاس ZibalPayment

کلاس `ZibalPayment` در فایل `subscriptions/views.py` تعریف شده است و متدهای زیر را فراهم می‌کند:

- `request_payment(data)`: ارسال درخواست پرداخت
- `verify_payment(track_id)`: تایید پرداخت
- `inquiry_payment(track_id)`: استعلام پرداخت
- `get_payment_url(track_id)`: دریافت آدرس صفحه پرداخت

## فرآیند پرداخت

1. کاربر در صفحه خرید اشتراک، اشتراک مورد نظر خود را انتخاب می‌کند
2. سیستم قیمت نهایی را با توجه به تخفیف‌ها و ارتقاء هوشمند محاسبه می‌کند
3. در صورت قیمت 0 یا کمتر، اشتراک به صورت مستقیم فعال می‌شود
4. در غیر این صورت، درخواست پرداخت به زیبال ارسال می‌شود
5. کاربر به صفحه پرداخت زیبال هدایت می‌شود
6. پس از پرداخت، کاربر به سایت باز می‌گردد
7. سیستم پرداخت را تایید می‌کند و در صورت موفقیت، اشتراک فعال می‌شود

## تست درگاه پرداخت

برای تست درگاه پرداخت می‌توانید از merchant_id `zibal` استفاده کنید. در این حالت همه پرداخت‌ها موفق در نظر گرفته می‌شوند.