{% extends 'base.html' %}
{% load static %}

{% block title %}خرید اشتراک - MobixAI{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/purchase.css' %}">

<div class="purchase-page">
    <div class="purchase-container">
        <!-- Page Header -->
        <div class="purchase-header">
            <span class="purchase-badge">
                <i class="fas fa-crown"></i> برنامه‌های اشتراک
            </span>
            <h1 class="purchase-title">انتخاب بهترین برنامه برای شما</h1>
            <p class="purchase-subtitle">
                با اشتراک MobixAI از قدرت کامل هوش مصنوعی برای رشد و موفقیت خود استفاده کنید
            </p>
        </div>
        
        <!-- Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" style="margin-bottom: 2rem;">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
        
        <!-- Smart Calculator Section -->
        <div class="smart-calculator">
            <div class="calculator-header">
                <div class="calculator-icon">
                    <i class="fas fa-calculator"></i>
                </div>
                <div>
                    <h3 class="calculator-title">محاسبه‌گر هوشمند پرداخت</h3>
                    <p class="calculator-description">سیستم ما ارزش باقیمانده اشتراک فعلی شما را محاسبه کرده و از قیمت جدید کسر می‌کند</p>
                </div>
            </div>
            <div id="remaining-value-result"></div>
        </div>
        
        <!-- Subscription Plans -->
        {% if subscriptions %}
        <div class="plans-grid">
            {% for subscription in subscriptions %}
            <div class="plan-card{% if forloop.counter == 2 %} featured{% endif %}">
                <!-- Plan Header -->
                <div class="plan-header">
                    <h2 class="plan-name">{{ subscription.name }}</h2>
                    <div class="plan-price">
                        <span class="final-price-{{ subscription.id }}">{{ subscription.price|floatformat:0 }}</span>
                        <span class="plan-currency">تومان</span>
                        <span class="original-price-{{ subscription.id }}" style="display: none;">{{ subscription.price|floatformat:0 }}</span>
                    </div>
                </div>
                
                <!-- Plan Body -->
                <div class="plan-body">
                    <p style="color: var(--text-secondary); margin-bottom: var(--gap-lg); text-align: center; line-height: 1.6;">{{ subscription.description }}</p>
                    
                    <!-- Plan Features -->
                    <ul class="plan-features">
                        <li>
                            <i class="fas fa-clock"></i>
                            <span class="feature-label">مدت اشتراک</span>
                            <span class="feature-value">{{ subscription.duration_days }} روز</span>
                        </li>
                        <li>
                            <i class="fas fa-coins"></i>
                            <span class="feature-label">حداکثر توکن</span>
                            <span class="feature-value">{{ subscription.max_tokens|default:"نامحدود" }}</span>
                        </li>
                        <li>
                            <i class="fas fa-tag"></i>
                            <span class="feature-label">کد محصول</span>
                            <span class="feature-value">{{ subscription.sku }}</span>
                        </li>
                        <li>
                            <i class="fas fa-headset"></i>
                            <span class="feature-label">پشتیبانی</span>
                            <span class="feature-value">24/7</span>
                        </li>
                        <li>
                            <i class="fas fa-shield-alt"></i>
                            <span class="feature-label">ضمانت کیفیت</span>
                            <span class="feature-value">کامل</span>
                        </li>
                    </ul>
                    
                    <!-- Discount Section -->
                    <div class="discount-section">
                        <div class="discount-header">
                            <i class="fas fa-percent discount-icon"></i>
                            <h4 class="discount-title">کد تخفیف دارید؟</h4>
                        </div>
                        <div class="discount-input-group">
                            <input type="text" class="discount-input discount-code-input" 
                                   placeholder="کد تخفیف خود را وارد کنید" 
                                   data-subscription-id="{{ subscription.id }}">
                            <button type="button" class="discount-btn apply-discount-btn" 
                                    data-subscription-id="{{ subscription.id }}">
                                <i class="fas fa-check"></i> اعمال
                            </button>
                        </div>
                        <div class="discount-result" id="discount-result-{{ subscription.id }}"></div>
                    </div>
                </div>
                
                <!-- Plan Footer -->
                <div class="plan-footer">
                    <form method="post" action="{% url 'initiate_payment' subscription.id %}" class="payment-form">
                        {% csrf_token %}
                        <input type="hidden" name="discount_code" id="discount-code-{{ subscription.id }}" value="">
                        <button type="submit" class="purchase-btn">
                            <i class="fas fa-shopping-cart"></i>
                            خرید اشتراک - <span class="final-price-{{ subscription.id }}">{{ subscription.price|floatformat:0 }}</span> تومان
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-inbox"></i>
            </div>
            <h2 class="empty-title">اشتراکی موجود نیست</h2>
            <p class="empty-description">
                در حال حاضر هیچ برنامه اشتراکی برای خرید فعال نیست. لطفاً بعداً مراجعه کنید.
            </p>
        </div>
        {% endif %}
        
        <!-- Purchase Guide Sidebar -->
        <div style="display: grid; grid-template-columns: 1fr 350px; gap: 2rem; align-items: start; margin-top: 3rem;">
            <div></div>
            <div class="purchase-guide">
                <h3 class="guide-title">
                    <i class="fas fa-info-circle"></i>
                    راهنمای خرید
                </h3>
                <ul class="guide-items">
                    <li class="guide-item">
                        <div class="guide-item-title">
                            <i class="fas fa-calculator"></i>
                            محاسبه هوشمند
                        </div>
                        <div class="guide-item-description">
                            ارزش باقیمانده اشتراک فعلی شما به طور خودکار محاسبه و از قیمت جدید کسر می‌شود
                        </div>
                    </li>
                    <li class="guide-item">
                        <div class="guide-item-title">
                            <i class="fas fa-percent"></i>
                            کدهای تخفیف
                        </div>
                        <div class="guide-item-description">
                            اگر کد تخفیف دارید، از تخفیف‌های ویژه بهره‌مند شوید
                        </div>
                    </li>
                    <li class="guide-item">
                        <div class="guide-item-title">
                            <i class="fas fa-shield-alt"></i>
                            پرداخت ایمن
                        </div>
                        <div class="guide-item-description">
                            پرداخت شما با بالاترین استانداردهای امنیتی محافظت می‌شود
                        </div>
                    </li>
                    <li class="guide-item">
                        <div class="guide-item-title">
                            <i class="fas fa-headset"></i>
                            پشتیبانی 24/7
                        </div>
                        <div class="guide-item-description">
                            تیم پشتیبانی ما آماده کمک به شما است
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Calculate remaining value automatically on page load
    fetch('{% url "calculate_remaining_value" %}')
    .then(response => response.json())
    .then(data => {
                        const resultDiv = document.getElementById('remaining-value-result');
                        if (data.error) {
                            resultDiv.innerHTML = `<div class="calculator-result error"><small>${data.error}</small></div>`;
                        } else {
                            // Calculate remaining tokens with proper display
                            const remainingTokens = data.remaining_tokens;
                            const totalTokenLimit = data.total_token_limit;
                            const tokensUsed = data.total_tokens_used;
                            
                            resultDiv.innerHTML = `
                                <div class="calculator-result">
                                    <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-info-circle"></i>
                                        اطلاعات اشتراک فعلی
                                    </h4>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; font-size: 14px;">
                                        <div><strong>نوع اشتراک:</strong> ${data.subscription_name}</div>
                                        <div><strong>قیمت اشتراک:</strong> ${data.subscription_price_tomans.toFixed(0)} تومان</div>
                                        <div><strong>توکن مصرفی:</strong> ${tokensUsed}</div>
                                        <div><strong>حداکثر توکن:</strong> ${totalTokenLimit}</div>
                                        <div><strong>توکن باقیمانده:</strong> ${remainingTokens}</div>
                                        <div><strong>روز باقیمانده:</strong> ${data.remaining_days}</div>
                                    </div>
                                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.2); text-align: center;">
                                        <strong style="font-size: 18px;">
                                            <i class="fas fa-coins"></i>
                                            ارزش کل باقیمانده: ${data.total_remaining_value_tomans.toFixed(0)} تومان
                                        </strong>
                                    </div>
                                </div>
                            `;
            
            // Update all subscription prices with the calculated remaining value ONLY if no discount has been applied
            document.querySelectorAll('[class^="final-price-"]').forEach(element => {
                // Extract subscription ID from class name
                const classList = element.className.split(' ');
                const finalPriceClass = classList.find(cls => cls.startsWith('final-price-'));
                if (finalPriceClass) {
                    const subscriptionId = finalPriceClass.split('-')[2];
                    const originalPriceElement = document.querySelector(`.original-price-${subscriptionId}`);
                    const discountResultElement = document.getElementById(`discount-result-${subscriptionId}`);
                    
                    // Only update if no discount has been applied (discount result is empty)
                    if (originalPriceElement && (!discountResultElement || !discountResultElement.innerHTML.trim())) {
                        const originalPrice = parseFloat(originalPriceElement.textContent);
                        const finalPrice = Math.max(0, originalPrice - data.total_remaining_value_tomans);
                        element.textContent = finalPrice.toFixed(0);
                        
                        // Also update the hidden discount code input with the final price
                        const discountCodeInput = document.getElementById(`discount-code-${subscriptionId}`);
                        if (discountCodeInput) {
                            discountCodeInput.setAttribute('data-final-price', finalPrice.toFixed(0));
                        }
                    }
                }
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const resultDiv = document.getElementById('remaining-value-result');
        resultDiv.innerHTML = `
            <div class="calculator-result error">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>خطا در محاسبه</strong>
                </div>
                <div style="margin-top: 0.5rem; font-size: 14px;">
                    امکان محاسبه مقدار باقیمانده وجود ندارد. لطفاً بعداً دوباره تلاش کنید.
                </div>
            </div>
        `;
    });
    
    // Apply discount code functionality
    document.querySelectorAll('.apply-discount-btn').forEach(button => {
        button.addEventListener('click', function() {
            const subscriptionId = this.getAttribute('data-subscription-id');
            const codeInput = document.querySelector(`.discount-code-input[data-subscription-id="${subscriptionId}"]`);
            const code = codeInput.value.trim();
            
            if (!code) {
                alert('لطفاً کد تخفیف را وارد کنید');
                return;
            }
            
            // Send AJAX request to apply discount
            fetch('{% url "apply_discount_code" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `code=${encodeURIComponent(code)}&subscription_id=${subscriptionId}`
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById(`discount-result-${subscriptionId}`);
                const finalPriceSpan = document.querySelector(`.final-price-${subscriptionId}`);
                const discountCodeInput = document.getElementById(`discount-code-${subscriptionId}`);
                
                if (data.success) {
                    // Update UI with discount information
                    resultDiv.innerHTML = `
                        <div class="discount-result success">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <i class="fas fa-check-circle"></i>
                                <strong>کد تخفیف با موفقیت اعمال شد!</strong>
                            </div>
                            <div>میزان تخفیف: <strong>${data.discount_amount.toFixed(0)} تومان</strong></div>
                            <div>قیمت نهایی: <strong>${data.final_price.toFixed(0)} تومان</strong></div>
                        </div>
                    `;
                    finalPriceSpan.textContent = data.final_price.toFixed(0);
                    discountCodeInput.value = data.discount_code;
                } else {
                    resultDiv.innerHTML = `
                        <div class="discount-result error">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-exclamation-circle"></i>
                                ${data.error}
                            </div>
                        </div>
                    `;
                    // Reset to original price minus remaining value
                    const originalPrice = document.querySelector(`.original-price-${subscriptionId}`).textContent;
                    const remainingValueResult = document.getElementById('remaining-value-result');
                    if (remainingValueResult && remainingValueResult.textContent) {
                        // Try to extract remaining value from the result
                        const remainingValueMatch = remainingValueResult.textContent.match(/ارزش کل باقیمانده: ([\d,]+)/);
                        if (remainingValueMatch) {
                            const remainingValue = parseFloat(remainingValueMatch[1].replace(/,/g, ''));
                            const finalPrice = Math.max(0, parseFloat(originalPrice) - remainingValue);
                            finalPriceSpan.textContent = finalPrice.toFixed(0);
                            
                            // If final price is 0, show a special message
                            if (finalPrice === 0) {
                                resultDiv.innerHTML = `
                                    <div class="discount-result success">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <i class="fas fa-gift"></i>
                                            <strong>عالی! پرداخت رایگان!</strong>
                                        </div>
                                        <div>ارزش باقیمانده شما برابر با قیمت اشتراک است. نیازی به پرداخت نیست.</div>
                                    </div>
                                `;
                            }
                        } else {
                            finalPriceSpan.textContent = originalPrice;
                        }
                    } else {
                        finalPriceSpan.textContent = originalPrice;
                    }
                    discountCodeInput.value = '';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const resultDiv = document.getElementById(`discount-result-${subscriptionId}`);
                resultDiv.innerHTML = `
                    <div class="discount-result error">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-exclamation-triangle"></i>
                            خطا در اعمال کد تخفیف. لطفاً دوباره تلاش کنید.
                        </div>
                    </div>
                `;
            });
        });
    });
    
    // Clear discount when form is submitted without a code
    document.querySelectorAll('.payment-form').forEach(form => {
        form.addEventListener('submit', function() {
            const subscriptionId = this.querySelector('.apply-discount-btn').getAttribute('data-subscription-id');
            const discountCodeInput = document.getElementById(`discount-code-${subscriptionId}`);
            const codeInput = document.querySelector(`.discount-code-input[data-subscription-id="${subscriptionId}"]`);
            
            if (!codeInput.value.trim() && discountCodeInput.value) {
                discountCodeInput.value = '';
            }
        });
    });
});
</script>
{% endblock %}