{% extends 'base.html' %}
{% load static %}
{% load subscription_extras %}

{% block title %}خرید اشتراک - MobixAI{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/purchase-mobile.css' %}">

<div class="purchase-page">
    <div class="purchase-container">
        <!-- Page Header -->
        <div class="purchase-header">
            <h1 class="purchase-title">انتخاب بهترین برنامه برای شما</h1>
            <p class="purchase-subtitle">
                با اشتراک MobixAI از قدرت کامل هوش مصنوعی برای رشد و موفقیت خود استفاده کنید
            </p>
        </div>
        
        <!-- Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" style="margin-bottom: 2rem;">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
        
        <!-- Smart Calculator Section - Toggleable -->
        <div class="smart-calculator">
            <div class="calculator-header" id="calculator-toggle">
                <div class="calculator-icon">
                    <i class="fas fa-calculator"></i>
                </div>
                <div class="calculator-title">محاسبه‌گر هوشمند پرداخت</div>
                <div class="toggle-icon">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="calculator-content" id="calculator-content">
                <p class="calculator-description">سیستم ما ارزش باقیمانده اشتراک فعلی شما را محاسبه کرده و از قیمت جدید کسر می‌کند</p>
                <div id="remaining-value-result"></div>
            </div>
        </div>
        
        <!-- Subscription Plans -->
        {% if subscriptions %}
        <div class="plans-grid">
            {% for subscription in subscriptions %}
            <div class="plan-card{% if forloop.counter == 2 %} featured{% endif %}">
                <!-- Plan Header -->
                <div class="plan-header">
                    <h2 class="plan-name">{{ subscription.name }}</h2>
                    <div class="plan-price" style="display: flex; justify-content: center; align-items: baseline;">
                        <span class="final-price-{{ subscription.id }}" data-price="{{ subscription.price|floatformat:0 }}"></span>
                        <span class="plan-currency">تومان</span>
                        <span class="original-price-{{ subscription.id }}" style="display: none;">{{ subscription.price|floatformat:0 }}</span>
                    </div>
                </div>
                
                <!-- Plan Body -->
                <div class="plan-body">
                    <!-- Plan Description with Markdown support -->
                    <div class="plan-description">
                        {{ subscription.description|linebreaks }}
                    </div>
                    
                    <!-- Plan Features -->
                    <ul class="plan-features">
                        <li>
                            <i class="fas fa-clock"></i>
                            <span class="feature-label">مدت اشتراک</span>
                            <span class="feature-value">{{ subscription.duration_days }} روز</span>
                        </li>
                        <li>
                            <i class="fas fa-coins"></i>
                            <span class="feature-label">حداکثر توکن</span>
                            <span class="feature-value">{{ subscription.max_tokens|default:"نامحدود" }}</span>
                        </li>
                        <!-- Removed SKU, Support, and Quality Guarantee features as requested -->
                    </ul>
                    
                    <!-- Discount Section -->
                    <div class="discount-section">
                        <div class="discount-header">
                            <i class="fas fa-percent discount-icon"></i>
                            <h4 class="discount-title">کد تخفیف دارید؟</h4>
                        </div>
                        <div class="discount-input-group">
                            <input type="text" class="discount-input discount-code-input" 
                                   placeholder="کد تخفیف خود را وارد کنید" 
                                   data-subscription-id="{{ subscription.id }}">
                            <button type="button" class="discount-btn apply-discount-btn" 
                                    data-subscription-id="{{ subscription.id }}">
                                <i class="fas fa-check"></i> اعمال
                            </button>
                        </div>
                        <div class="discount-result" id="discount-result-{{ subscription.id }}"></div>
                    </div>
                </div>
                
                <!-- Plan Footer -->
                <div class="plan-footer">
                    <form method="post" action="{% url 'initiate_payment' subscription.id %}" class="payment-form">
                        {% csrf_token %}
                        <input type="hidden" name="discount_code" id="discount-code-{{ subscription.id }}" value="">
                        <button type="submit" class="purchase-btn">
                            <i class="fas fa-shopping-cart"></i>
                            خرید اشتراک - <span class="final-price-btn-{{ subscription.id }}" data-price="{{ subscription.price|floatformat:0 }}"></span> تومان
                        </button>

                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-inbox"></i>
            </div>
            <h2 class="empty-title">اشتراکی موجود نیست</h2>
            <p class="empty-description">
                در حال حاضر هیچ برنامه اشتراکی برای خرید فعال نیست. لطفاً بعداً مراجعه کنید.
            </p>
        </div>
        {% endif %}
        
        <!-- Subscription Comparison Table (Now visible on mobile) -->
        <div class="comparison-section">
            <div class="comparison-header">
                <h2 class="comparison-title">مقایسه جامع پلن‌های اشتراک</h2>
                <p class="comparison-subtitle">برای انتخاب بهترین پلن، تمام ویژگی‌ها و محدودیت‌های هر پلن را مقایسه کنید</p>
            </div>
            
            <div class="comparison-table-container">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th class="feature-header">ویژگی‌ها</th>
                            {% for subscription in subscriptions %}
                            <th class="plan-header-comparison">{{ subscription.name }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Token Limits -->
                        <tr>
                            <td class="feature-name">
                                <div class="feature-info">
                                    <i class="fas fa-coins"></i>
                                    <span>حداکثر توکن</span>
                                </div>
                            </td>
                            {% for subscription in subscriptions %}
                            <td class="feature-value">
                                {% if subscription.max_tokens > 0 %}
                                    {{ subscription.max_tokens|floatformat:0 }}
                                {% else %}
                                    <span class="unlimited">نامحدود</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        
                        <!-- File Upload Settings -->
                        <tr>
                            <td class="feature-name">
                                <div class="feature-info">
                                    <i class="fas fa-file-upload"></i>
                                    <span>حداکثر حجم فایل</span>
                                </div>
                            </td>
                            {% for subscription in subscriptions %}
                            <td class="feature-value">
                                {% if subscription.file_upload_settings %}
                                    {% if subscription_file_size > 0 %}
                                        {{ subscription.file_upload_settings.max_file_size|filesizeformat }}
                                    {% else %}
                                        <span class="unlimited">نامحدود</span>
                                    {% endif %}
                                {% else %}
                                    <span class="na">-</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        
                        <tr>
                            <td class="feature-name">
                                <div class="feature-info">
                                    <i class="fas fa-file-alt"></i>
                                    <span>حداکثر فایل در روز</span>
                                </div>
                            </td>
                            {% for subscription in subscriptions %}
                            <td class="feature-value">
                                {% if subscription.file_upload_settings %}
                                    {% if subscription.file_upload_settings.daily_file_limit > 0 %}
                                        {{ subscription.file_upload_settings.daily_file_limit }}
                                    {% else %}
                                        <span class="unlimited">نامحدود</span>
                                    {% endif %}
                                {% else %}
                                    <span class="na">-</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        
                        <tr>
                            <td class="feature-name">
                                <div class="feature-info">
                                    <i class="fas fa-file-medical"></i>
                                    <span>حداکثر فایل در ماه</span>
                                </div>
                            </td>
                            {% for subscription in subscriptions %}
                            <td class="feature-value">
                                {% if subscription.file_upload_settings %}
                                    {% if subscription.file_upload_settings.monthly_file_limit > 0 %}
                                        {{ subscription.file_upload_settings.monthly_file_limit }}
                                    {% else %}
                                        <span class="unlimited">نامحدود</span>
                                    {% endif %}
                                {% else %}
                                    <span class="na">-</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        
                        <!-- Web Search Settings -->
                        <tr>
                            <td class="feature-name">
                                <div class="feature-info">
                                    <i class="fas fa-search"></i>
                                    <span>قابلیت جستجوی وب</span>
                                </div>
                            </td>
                            {% for subscription in subscriptions %}
                            <td class="feature-value">
                                {% if subscription.websearchsettings_set.all %}
                                    <span class="available">
                                        <i class="fas fa-check-circle"></i>
                                        دارد
                                    </span>
                                {% else %}
                                    <span class="unavailable">
                                        <i class="fas fa-times-circle"></i>
                                        ندارد
                                    </span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        
                        <!-- Image Generation Limits -->
                        <tr>
                            <td class="feature-name">
                                <div class="feature-info">
                                    <i class="fas fa-image"></i>
                                    <span>تولید تصویر روزانه</span>
                                </div>
                            </td>
                            {% for subscription in subscriptions %}
                            <td class="feature-value">
                                {% if subscription.daily_image_generation_limit > 0 %}
                                    {{ subscription.daily_image_generation_limit }}
                                {% else %}
                                    <span class="unlimited">نامحدود</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        
                        <tr>
                            <td class="feature-name">
                                <div class="feature-info">
                                    <i class="fas fa-images"></i>
                                    <span>تولید تصویر ماهانه</span>
                                </div>
                            </td>
                            {% for subscription in subscriptions %}
                            <td class="feature-value">
                                {% if subscription.monthly_image_generation_limit > 0 %}
                                    {{ subscription.monthly_image_generation_limit }}
                                {% else %}
                                    <span class="unlimited">نامحدود</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        
                        <!-- Message Limits -->
                        <tr>
                            <td class="feature-name">
                                <div class="feature-info">
                                    <i class="fas fa-comments"></i>
                                    <span>پیام‌های روزانه</span>
                                </div>
                            </td>
                            {% for subscription in subscriptions %}
                            <td class="feature-value">
                                {% if subscription.daily_max_messages > 0 %}
                                    {{ subscription.daily_max_messages }}
                                {% else %}
                                    <span class="unlimited">نامحدود</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        
                        <!-- Duration -->
                        <tr>
                            <td class="feature-name">
                                <div class="feature-info">
                                    <i class="fas fa-clock"></i>
                                    <span>مدت اشتراک</span>
                                </div>
                            </td>
                            {% for subscription in subscriptions %}
                            <td class="feature-value">
                                {{ subscription.duration_days }} روز
                            </td>
                            {% endfor %}
                        </tr>
                        

                        
                        <!-- AI Models Access - Restructured as requested -->
                        {% for model in all_ai_models %}
                        <tr>
                            <td class="feature-name">
                                <div class="feature-info">
                                    <i class="fas fa-robot"></i>
                                    <span>{{ model.name }}</span>
                                </div>
                            </td>
                            {% for subscription in subscriptions %}
                            <td class="feature-value">
                                {% if model.id in subscription_model_access|get_item:subscription.id %}
                                    <div class="model-access-indicator model-access-yes">
                                        <i class="fas fa-check"></i>
                                    </div>
                                {% else %}
                                    <div class="model-access-indicator model-access-no">
                                        <i class="fas fa-times"></i>
                                    </div>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
    </div>
</div>

<script>
// Function to format price with "/" separator and different font sizes (Persian format - left to right)
function formatPrice(price) {
    // Convert to string and remove any non-digit characters
    let priceStr = price.toString().replace(/\D/g, '');
    
    // If price is empty or not a number, return as is
    if (!priceStr || isNaN(priceStr)) {
        return price;
    }
    
    // Add "/" separator every 3 digits from left to right
    let formatted = '';
    for (let i = 0; i < priceStr.length; i++) {
        if (i > 0 && (priceStr.length - i) % 3 === 0) {
            formatted += '/';
        }
        formatted += priceStr[i];
    }
    
    return formatted;
}

// Function to create HTML with different font sizes for first 3 digits and the rest (Persian format)
function createFormattedPriceHTML(price, isSmall = false) {
    const formatted = formatPrice(price);
    if (!formatted) return '';
    
    // Split by "/" to get digit groups
    const parts = formatted.split('/');
    
    // If only one part (less than 4 digits), make all large
    if (parts.length === 1) {
        return `<span class="formatted-price${isSmall ? ' small' : ''}">` +
               `<span class="large-digits">${formatted}</span>` +
               `</span>`;
    }
    
    // Take the first part (leftmost) as large digits
    const largePart = parts[0];
    
    // Join the rest with "/" separators as small digits
    const smallPart = parts.slice(1).join('/');
    
    return `<span class="formatted-price${isSmall ? ' small' : ''}">` +
           `<span class="large-digits">${largePart}</span>` +
           `<span class="separator">/</span>` +
           `<span class="small-digits">${smallPart}</span>` +
           `</span>`;
}

// Toggle calculator visibility
document.addEventListener('DOMContentLoaded', function() {
    const calculatorToggle = document.getElementById('calculator-toggle');
    const calculatorContent = document.getElementById('calculator-content');
    const toggleIcon = calculatorToggle.querySelector('.toggle-icon');
    
    calculatorToggle.addEventListener('click', function() {
        calculatorContent.classList.toggle('expanded');
        toggleIcon.classList.toggle('rotated');
    });
    
    // Format all prices on the page
    document.querySelectorAll('[data-price]').forEach(element => {
        const price = element.getAttribute('data-price');
        const isSmall = element.classList.contains('formatted-price') && element.classList.contains('small');
        element.innerHTML = createFormattedPriceHTML(price, isSmall);
    });
    
    // Calculate remaining value automatically on page load
    fetch('{% url "calculate_remaining_value" %}')
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('remaining-value-result');
        if (!resultDiv) {
            console.error('Result div not found');
            return;
        }
        
        if (data.error) {
            resultDiv.innerHTML = `<div class="calculator-result error"><small>${data.error}</small></div>`;
        } else {
            // Calculate remaining tokens with proper display
            const remainingTokens = data.remaining_tokens;
            const totalTokenLimit = data.total_token_limit;
            const tokensUsed = data.total_tokens_used;
            
            resultDiv.innerHTML = `
                <div class="calculator-result">
                    <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-info-circle"></i>
                        اطلاعات اشتراک فعلی
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; font-size: 14px;">
                        <div><strong>نوع اشتراک:</strong> ${data.subscription_name}</div>
                        <div><strong>قیمت اشتراک:</strong> ${data.subscription_price_tomans.toFixed(0)} تومان</div>
                        <div><strong>توکن مصرفی:</strong> ${tokensUsed}</div>
                        <div><strong>حداکثر توکن:</strong> ${totalTokenLimit}</div>
                        <div><strong>توکن باقیمانده:</strong> ${remainingTokens}</div>
                        <div><strong>روز باقیمانده:</strong> ${data.remaining_days}</div>
                    </div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.2); text-align: center;">
                        <strong style="font-size: 18px;">
                            <i class="fas fa-coins"></i>
                            ارزش کل باقیمانده: ${data.total_remaining_value_tomans.toFixed(0)} تومان
                        </strong>
                    </div>
                </div>
            `;

            // Update all subscription prices with the calculated remaining value ONLY if no discount has been applied
            document.querySelectorAll('[class^="final-price-"]').forEach(element => {
                // Extract subscription ID from class name
                const classList = element.className.split(' ');
                const finalPriceClass = classList.find(cls => cls.startsWith('final-price-'));
                if (finalPriceClass) {
                    const subscriptionId = finalPriceClass.split('-')[2];
                    const originalPriceElement = document.querySelector(`.original-price-${subscriptionId}`);
                    const discountResultElement = document.getElementById(`discount-result-${subscriptionId}`);
                    const planFooter = element.closest('.plan-footer');
                    const purchaseButton = planFooter ? planFooter.querySelector('.purchase-btn') : null;
                    
                    // Only update if no discount has been applied (discount result is empty)
                    if (originalPriceElement && (!discountResultElement || !discountResultElement.innerHTML.trim())) {
                        const originalPrice = parseFloat(originalPriceElement.textContent);
                        const finalPrice = Math.max(0, originalPrice - data.total_remaining_value_tomans);
                        element.setAttribute('data-price', finalPrice.toFixed(0));
                        element.innerHTML = createFormattedPriceHTML(finalPrice.toFixed(0));
                        
                        // Also update the button price
                        const buttonPriceElement = document.querySelector(`.final-price-btn-${subscriptionId}`);
                        if (buttonPriceElement) {
                            buttonPriceElement.setAttribute('data-price', finalPrice.toFixed(0));
                            buttonPriceElement.innerHTML = createFormattedPriceHTML(finalPrice.toFixed(0));
                        }
                        
                        // Also update the hidden discount code input with the final price
                        const discountCodeInput = document.getElementById(`discount-code-${subscriptionId}`);
                        if (discountCodeInput) {
                            discountCodeInput.setAttribute('data-final-price', finalPrice.toFixed(0));
                        }
                        
                        // Disable payment button if remaining value is greater than original price
                        if (purchaseButton && data.total_remaining_value_tomans > originalPrice) {
                            purchaseButton.disabled = true;
                            purchaseButton.innerHTML = '<i class="fas fa-lock"></i> پرداخت غیرفعال - ارزش باقیمانده بیشتر از قیمت اشتراک';
                            purchaseButton.style.opacity = '0.7';
                            purchaseButton.style.cursor = 'not-allowed';
                        }
                    }
                }
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const resultDiv = document.getElementById('remaining-value-result');
        if (resultDiv) {
            resultDiv.innerHTML = `
                <div class="calculator-result error">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>خطا در محاسبه</strong>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 14px;">
                        امکان محاسبه مقدار باقیمانده وجود ندارد. لطفاً بعداً دوباره تلاش کنید.
                        <br><small>جزئیات خطا: ${error.message || 'Unknown error'}</small>
                    </div>
                </div>
            `;
        }
    });
    
    // Apply discount code functionality
    document.querySelectorAll('.apply-discount-btn').forEach(button => {
        button.addEventListener('click', function() {
            const subscriptionId = this.getAttribute('data-subscription-id');
            const codeInput = document.querySelector(`.discount-code-input[data-subscription-id="${subscriptionId}"]`);
            const code = codeInput ? codeInput.value.trim() : '';
            
            if (!code) {
                alert('لطفاً کد تخفیف را وارد کنید');
                return;
            }
            
            // Get CSRF token
            const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfTokenElement) {
                alert('خطا در ارسال درخواست. لطفاً صفحه را دوباره بارگذاری کنید.');
                return;
            }
            
            // Send AJAX request to apply discount
            fetch('{% url "apply_discount_code" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfTokenElement.value
                },
                body: `code=${encodeURIComponent(code)}&subscription_id=${subscriptionId}`
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById(`discount-result-${subscriptionId}`);
                const finalPriceSpan = document.querySelector(`.final-price-${subscriptionId}`);
                const finalPriceBtnSpan = document.querySelector(`.final-price-btn-${subscriptionId}`);
                const discountCodeInput = document.getElementById(`discount-code-${subscriptionId}`);
                const planFooter = finalPriceSpan ? finalPriceSpan.closest('.plan-footer') : null;
                const purchaseButton = planFooter ? planFooter.querySelector('.purchase-btn') : null;
                
                if (data.success) {
                    // Update UI with discount information
                    if (resultDiv) {
                        resultDiv.innerHTML = `
                            <div class="discount-result success">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <i class="fas fa-check-circle"></i>
                                    <strong>کد تخفیف با موفقیت اعمال شد!</strong>
                                </div>
                                <div>میزان تخفیف: <strong>${data.discount_amount.toFixed(0)} تومان</strong></div>
                                <div>قیمت نهایی: <strong>${data.final_price.toFixed(0)} تومان</strong></div>
                            </div>
                        `;
                    }
                    if (finalPriceSpan) {
                        finalPriceSpan.setAttribute('data-price', data.final_price.toFixed(0));
                        finalPriceSpan.innerHTML = createFormattedPriceHTML(data.final_price.toFixed(0));
                    }
                    if (finalPriceBtnSpan) {
                        finalPriceBtnSpan.setAttribute('data-price', data.final_price.toFixed(0));
                        finalPriceBtnSpan.innerHTML = createFormattedPriceHTML(data.final_price.toFixed(0));
                    }
                    if (discountCodeInput) {
                        discountCodeInput.value = data.discount_code;
                    }
                    
                    // Disable payment button if final price is 0 or negative
                    if (purchaseButton && data.final_price <= 0) {
                        purchaseButton.disabled = true;
                        purchaseButton.innerHTML = '<i class="fas fa-gift"></i> پرداخت رایگان - نیازی به پرداخت نیست';
                        purchaseButton.style.opacity = '0.7';
                        purchaseButton.style.cursor = 'not-allowed';
                    } else if (purchaseButton) {
                        // Re-enable button if it was previously disabled
                        purchaseButton.disabled = false;
                        purchaseButton.innerHTML = `<i class="fas fa-shopping-cart"></i> خرید اشتراک - ${createFormattedPriceHTML(data.final_price.toFixed(0))} تومان`;
                        purchaseButton.style.opacity = '1';
                        purchaseButton.style.cursor = 'pointer';
                        
                        // Check again if remaining value is greater than the final price after discount
                        if (data.total_remaining_value_tomans > data.final_price) {
                            purchaseButton.disabled = true;
                            purchaseButton.innerHTML = '<i class="fas fa-lock"></i> پرداخت غیرفعال - ارزش باقیمانده بیشتر از قیمت اشتراک';
                            purchaseButton.style.opacity = '0.7';
                            purchaseButton.style.cursor = 'not-allowed';
                        }
                    }
                } else {
                    if (resultDiv) {
                        resultDiv.innerHTML = `
                            <div class="discount-result error">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-exclamation-circle"></i>
                                    ${data.error}
                                </div>
                            </div>
                        `;
                    }
                    // Reset to original price minus remaining value
                    const originalPriceElement = document.querySelector(`.original-price-${subscriptionId}`);
                    const remainingValueResult = document.getElementById('remaining-value-result');
                    if (originalPriceElement && remainingValueResult && remainingValueResult.textContent) {
                        // Try to extract remaining value from the result
                        const remainingValueMatch = remainingValueResult.textContent.match(/ارزش کل باقیمانده: ([\d,]+)/);
                        const originalPrice = originalPriceElement.textContent;
                        if (remainingValueMatch && finalPriceSpan) {
                            const remainingValue = parseFloat(remainingValueMatch[1].replace(/,/g, ''));
                            const finalPrice = Math.max(0, parseFloat(originalPrice) - remainingValue);
                            finalPriceSpan.setAttribute('data-price', finalPrice.toFixed(0));
                            finalPriceSpan.innerHTML = createFormattedPriceHTML(finalPrice.toFixed(0));
                            
                            if (finalPriceBtnSpan) {
                                finalPriceBtnSpan.setAttribute('data-price', finalPrice.toFixed(0));
                                finalPriceBtnSpan.innerHTML = createFormattedPriceHTML(finalPrice.toFixed(0));
                            }
                            
                            // Check if we should disable the button based on remaining value
                            if (purchaseButton && remainingValue > parseFloat(originalPrice)) {
                                purchaseButton.disabled = true;
                                purchaseButton.innerHTML = '<i class="fas fa-lock"></i> پرداخت غیرفعال - ارزش باقیمانده بیشتر از قیمت اشتراک';
                                purchaseButton.style.opacity = '0.7';
                                purchaseButton.style.cursor = 'not-allowed';
                            } else if (purchaseButton) {
                                // Re-enable button if it was previously disabled due to remaining value
                                purchaseButton.disabled = false;
                                purchaseButton.innerHTML = `<i class="fas fa-shopping-cart"></i> خرید اشتراک - ${createFormattedPriceHTML(finalPrice.toFixed(0))} تومان`;
                                purchaseButton.style.opacity = '1';
                                purchaseButton.style.cursor = 'pointer';
                                
                                // Check again if remaining value is greater than the final price
                                if (remainingValue > finalPrice) {
                                    purchaseButton.disabled = true;
                                    purchaseButton.innerHTML = '<i class="fas fa-lock"></i> پرداخت غیرفعال - ارزش باقیمانده بیشتر از قیمت اشتراک';
                                    purchaseButton.style.opacity = '0.7';
                                    purchaseButton.style.cursor = 'not-allowed';
                                }
                            }
                            
                            // If final price is 0, show a special message
                            if (finalPrice === 0) {
                                if (resultDiv) {
                                    resultDiv.innerHTML = `
                                        <div class="discount-result success">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                <i class="fas fa-gift"></i>
                                                <strong>عالی! پرداخت رایگان!</strong>
                                            </div>
                                            <div>ارزش باقیمانده شما برابر با قیمت اشتراک است. نیازی به پرداخت نیست.</div>
                                        </div>
                                    `;
                                }
                            }
                        } else if (finalPriceSpan) {
                            finalPriceSpan.setAttribute('data-price', originalPrice);
                            finalPriceSpan.innerHTML = createFormattedPriceHTML(originalPrice);
                            
                            if (finalPriceBtnSpan) {
                                finalPriceBtnSpan.setAttribute('data-price', originalPrice);
                                finalPriceBtnSpan.innerHTML = createFormattedPriceHTML(originalPrice);
                            }
                            
                            // Re-enable button with original price
                            if (purchaseButton) {
                                purchaseButton.disabled = false;
                                purchaseButton.innerHTML = `<i class="fas fa-shopping-cart"></i> خرید اشتراک - ${createFormattedPriceHTML(originalPrice)} تومان`;
                                purchaseButton.style.opacity = '1';
                                purchaseButton.style.cursor = 'pointer';
                            }
                        }
                    } else if (originalPriceElement && finalPriceSpan) {
                        finalPriceSpan.setAttribute('data-price', originalPriceElement.textContent);
                        finalPriceSpan.innerHTML = createFormattedPriceHTML(originalPriceElement.textContent);
                        
                        if (finalPriceBtnSpan) {
                            finalPriceBtnSpan.setAttribute('data-price', originalPriceElement.textContent);
                            finalPriceBtnSpan.innerHTML = createFormattedPriceHTML(originalPriceElement.textContent);
                        }
                        
                        // Re-enable button with original price
                        if (purchaseButton) {
                            purchaseButton.disabled = false;
                            purchaseButton.innerHTML = `<i class="fas fa-shopping-cart"></i> خرید اشتراک - ${createFormattedPriceHTML(originalPriceElement.textContent)} تومان`;
                            purchaseButton.style.opacity = '1';
                            purchaseButton.style.cursor = 'pointer';
                        }
                    }
                    if (discountCodeInput) {
                        discountCodeInput.value = '';
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const resultDiv = document.getElementById(`discount-result-${subscriptionId}`);
                if (resultDiv) {
                    resultDiv.innerHTML = `
                        <div class="discount-result error">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-exclamation-triangle"></i>
                                خطا در اعمال کد تخفیف. لطفاً دوباره تلاش کنید.
                            </div>
                        </div>
                    `;
                }
            });
        });
    });
    
    // Clear discount when form is submitted without a code
    document.querySelectorAll('.payment-form').forEach(form => {
        form.addEventListener('submit', function() {
            const applyButton = this.querySelector('.apply-discount-btn');
            if (applyButton) {
                const subscriptionId = applyButton.getAttribute('data-subscription-id');
                const discountCodeInput = document.getElementById(`discount-code-${subscriptionId}`);
                const codeInput = document.querySelector(`.discount-code-input[data-subscription-id="${subscriptionId}"]`);
                
                if (codeInput && !codeInput.value.trim() && discountCodeInput) {
                    discountCodeInput.value = '';
                }
            }
        });
    });
});
</script>

{% endblock %}