{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Sidebar - Collapsible on mobile -->
        <div class="col-lg-3 col-md-4 mb-4" id="sidebar">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">چت‌های من</h5>
                    <button class="btn btn-sm btn-light d-md-none" id="toggle-sidebar" title="بستن/باز کردن منو">
                        <i class="fas fa-times"></i>
                    </button>
                    <button class="btn btn-sm btn-light" id="new-chat-btn" title="چت جدید">
                        <i class="fas fa-plus"></i> جدید
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="sessions-list">
                        <!-- Sessions will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Available Chatbots -->
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">چت‌بات‌های موجود</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">انتخاب چت‌بات</label>
                        <select class="form-select" id="chatbot-select">
                            <option value="">-- چت‌باتی را انتخاب کنید --</option>
                            {% for chatbot in available_chatbots %}
                                <option value="{{ chatbot.id }}">
                                    {{ chatbot.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <button class="btn btn-success w-100" id="start-chat-btn" disabled>
                        <i class="fas fa-comment"></i> شروع چت
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="col-lg-9 col-md-8" id="main-content">
            <!-- Mobile header with sidebar toggle -->
            <div class="d-md-none mb-3">
                <button class="btn btn-primary w-100" id="open-sidebar-mobile">
                    <i class="fas fa-bars"></i> باز کردن منوی چت‌ها
                </button>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 id="current-session-title">
                        <i class="fas fa-comments"></i> چت را انتخاب کنید یا جدیدی ایجاد کنید
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-danger" id="delete-session-btn" style="display: none;">
                            <i class="fas fa-trash"></i> حذف چت
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="chat-container" class="chat-messages">
                        <div class="text-center text-muted welcome-message" id="welcome-message">
                            <i class="fas fa-robot fa-3x mb-3"></i>
                            <h4>به چت‌بات MobixAI خوش آمدید</h4>
                            <p class="mb-0">چتی را انتخاب کنید یا چت جدیدی شروع کنید</p>
                        </div>
                        <!-- Chat messages will appear here -->
                    </div>
                    <div class="input-group mt-3">
                        <textarea class="form-control" id="message-input" placeholder="پیام خود را تایپ کنید..." rows="2" disabled></textarea>
                        <button class="btn btn-primary" type="button" id="send-button" disabled>
                            <i class="fas fa-paper-plane"></i> ارسال
                        </button>
                    </div>
                    <!-- Web Search and PDF Upload section for text generation chatbots -->
                    <div class="mt-2" id="text-features-section" style="display: none;">
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-outline-info btn-sm" type="button" id="web-search-btn">
                                <i class="fas fa-search"></i> جستجوی وب
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" type="button" id="pdf-upload-btn">
                                <i class="fas fa-file-pdf"></i> آپلود PDF
                            </button>
                        </div>
                        <!-- PDF upload container -->
                        <div id="pdf-upload-container" class="mt-2" style="display: none;">
                            <div class="input-group">
                                <input type="file" class="form-control" id="pdf-input" accept="application/pdf,.pdf">
                                <button class="btn btn-outline-secondary" type="button" id="pdf-url-btn">آدرس PDF</button>
                            </div>
                            <div class="mt-2">
                                <select class="form-select form-select-sm" id="pdf-engine-select">
                                    <option value="pdf-text">متن PDF</option>
                                    <option value="mistral-ocr">OCR تصویری</option>
                                    <option value="native">پردازش بومی</option>
                                </select>
                            </div>
                            <small class="text-muted">فقط فایل‌های PDF پشتیبانی می‌شوند</small>
                        </div>
                        <!-- PDF URL input container -->
                        <div id="pdf-url-container" class="mt-2" style="display: none;">
                            <div class="input-group">
                                <input type="url" class="form-control" id="pdf-url-input" placeholder="آدرس فایل PDF">
                                <button class="btn btn-outline-secondary" type="button" id="pdf-file-btn">فایل PDF</button>
                            </div>
                            <div class="mt-2">
                                <select class="form-select form-select-sm" id="pdf-url-engine-select">
                                    <option value="pdf-text">متن PDF</option>
                                    <option value="mistral-ocr">OCR تصویری</option>
                                    <option value="native">پردازش بومی</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <!-- Image upload section for image generation chatbots -->
                    <div class="mt-2" id="image-upload-section" style="display: none;">
                        <div class="input-group">
                            <input type="file" class="form-control" id="image-input" accept="image/*">
                        </div>
                        <!-- Image preview container -->
                        <div id="image-preview-container" class="mt-2" style="display: none;">
                            <img id="image-preview" src="" alt="پیش‌نمایش تصویر" class="img-thumbnail" style="max-height: 150px; max-width: 200px;">
                            <button type="button" class="btn btn-sm btn-danger mt-1" id="remove-image-btn">
                                <i class="fas fa-times"></i> حذف تصویر
                            </button>
                        </div>
                        <small class="text-muted">فقط تصاویر با فرمت‌های PNG, JPG, WEBP, GIF پشتیبانی می‌شوند</small>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> Shift + Enter برای خط جدید | Enter برای ارسال
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div class="modal fade" id="newChatModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle"></i> ایجاد چت جدید
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-robot"></i> انتخاب چت‌بات
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">چت‌بات</label>
                                    <select class="form-select" id="modal-chatbot-select">
                                        <option value="">-- چت‌باتی را انتخاب کنید --</option>
                                        {% for chatbot in available_chatbots %}
                                            <option value="{{ chatbot.id }}" data-has-model="{% if chatbot.ai_model %}true{% else %}false{% endif %}">
                                                {{ chatbot.name }}
                                                {% if not chatbot.ai_model %}
                                                    <span class="badge bg-warning">نیاز به انتخاب مدل</span>
                                                {% endif %}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-microchip"></i> انتخاب مدل AI
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">مدل هوش مصنوعی</label>
                                    <select class="form-select" id="modal-model-select">
                                        <option value="">-- مدلی را انتخاب کنید --</option>
                                        {% for model in available_models %}
                                            <option value="{{ model.model_id }}" data-is-free="{{ model.is_free }}">
                                                {{ model.name }} 
                                                {% if model.is_free %}
                                                    <span class="badge bg-success">رایگان</span>
                                                {% else %}
                                                    <span class="badge bg-warning">ویژه</span>
                                                {% endif %}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i> 
                    توجه: شما باید یک چت‌بات انتخاب کنید. برخی چت‌بات‌ها نیاز به انتخاب مدل هوش مصنوعی دارند.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> لغو
                </button>
                <button type="button" class="btn btn-primary" id="create-chat-btn" disabled>
                    <i class="fas fa-comment"></i> ایجاد چت
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* RTL (Right-to-Left) styles for Persian */
    body {
        direction: rtl;
        text-align: right;
    }
    
    .chat-messages {
        height: 500px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 0.375rem;
        padding: 15px;
        background-color: #f8f9fa;
    }
    
    .message-user {
        background-color: #0d6efd;
        color: white;
        border-radius: 15px 15px 0 15px;
        padding: 12px 15px;
        margin-bottom: 15px;
        max-width: 80%;
        margin-left: auto;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .message-assistant {
        background-color: #e9ecef;
        border-radius: 15px 15px 15px 0;
        padding: 12px 15px;
        margin-bottom: 15px;
        max-width: 80%;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .message-user strong, .message-assistant strong {
        display: block;
        margin-bottom: 5px;
        font-size: 0.9em;
    }
    
    .session-item {
        cursor: pointer;
        border-left: 3px solid transparent;
        transition: all 0.2s ease;
    }
    
    .session-item:hover {
        background-color: #f8f9fa;
    }
    
    .session-item.active {
        background-color: #e9ecef;
        border-left: 3px solid #0d6efd;
    }
    
    .image-preview {
        max-width: 100%;
        border-radius: 8px;
        margin-top: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    /* Ensure preview images in chat are not too large */
    .message-user .image-preview, .message-assistant .image-preview {
        max-width: 300px;
        max-height: 300px;
        object-fit: contain;
    }
    
    .model-access {
        font-size: 0.7em;
        padding: 2px 6px;
        border-radius: 4px;
        vertical-align: middle;
    }
    
    .free {
        background-color: #d4edda;
        color: #155724;
    }
    
    .premium {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .typing-indicator {
        display: inline-block;
        padding: 12px 15px;
        background-color: #e9ecef;
        border-radius: 15px 15px 15px 0;
        margin-bottom: 15px;
    }
    
    .typing-indicator span {
        height: 8px;
        width: 8px;
        float: left;
        margin: 0 1px;
        background-color: #9E9EA1;
        display: block;
        border-radius: 50%;
        opacity: 0.4;
    }
    
    .typing-indicator span:nth-of-type(1) {
        animation: typing 1s infinite;
    }
    
    .typing-indicator span:nth-of-type(2) {
        animation: typing 1s infinite 0.2s;
    }
    
    .typing-indicator span:nth-of-type(3) {
        animation: typing 1s infinite 0.4s;
    }
    
    @keyframes typing {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-5px); }
        100% { transform: translateY(0px); }
    }
    
    .welcome-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        width: 100%;
    }
    
    .card.border-primary, .card.border-info {
        transition: transform 0.2s;
    }
    
    .card.border-primary:hover, .card.border-info:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .chat-messages {
            height: 400px;
        }
        
        .message-user, .message-assistant {
            max-width: 90%;
        }
        
        .card-header h5 {
            font-size: 1rem;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .modal-dialog {
            margin: 10px;
        }
        
        .modal-lg {
            max-width: 100%;
        }
        
        /* Improved mobile layout */
        .row {
            margin: 0;
        }
        
        .col-lg-3, .col-lg-9, .col-md-4, .col-md-8 {
            padding: 5px;
        }
        
        .card {
            margin-bottom: 10px;
        }
        
        .list-group-item {
            padding: 0.5rem;
        }
        
        .input-group textarea {
            font-size: 0.9rem;
        }
        
        .message-user, .message-assistant {
            padding: 10px;
            font-size: 0.9rem;
        }
        
        /* Collapsible sidebar for mobile */
        #sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 80%;
            height: 100%;
            background: white;
            z-index: 1050;
            overflow-y: auto;
            box-shadow: -2px 0 5px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
            transform: translateX(0);
        }
        
        #sidebar.hidden {
            transform: translateX(100%);
        }
        
        #main-content {
            width: 100%;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1040;
            display: none;
        }
        
        .overlay.show {
            display: block;
        }
    }
    
    @media (max-width: 576px) {
        .chat-messages {
            height: 300px;
            padding: 10px;
        }
        
        .message-user, .message-assistant {
            padding: 8px 10px;
            max-width: 95%;
            font-size: 0.85rem;
        }
        
        .card-header {
            padding: 0.5rem;
        }
        
        .card-body {
            padding: 0.75rem;
        }
        
        .input-group textarea {
            font-size: 0.875rem;
            padding: 0.5rem;
        }
        
        .btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        
        .session-item strong {
            font-size: 0.9rem;
        }
        
        .session-item .small {
            font-size: 0.75rem;
        }
        
        .model-access {
            font-size: 0.6rem;
            padding: 1px 4px;
        }
        
        /* Adjust modal for small screens */
        .modal-content {
            margin: 10px;
        }
        
        .modal-body {
            padding: 10px;
        }
        
        .modal-footer {
            padding: 10px;
        }
        
        /* Stack cards on small screens */
        .row .col-md-6 {
            margin-bottom: 15px;
        }
    }
    
    /* Extra small devices */
    @media (max-width: 400px) {
        .chat-messages {
            height: 250px;
        }
        
        .message-user, .message-assistant {
            padding: 6px 8px;
            font-size: 0.8rem;
        }
        
        .input-group textarea {
            font-size: 0.8rem;
            padding: 0.4rem;
        }
        
        .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
    }
</style>

<script>
    let currentSessionId = null;
    let isStreaming = false;
    
    // Load user sessions
    function loadSessions() {
        fetch('{% url "get_user_sessions" %}')
            .then(response => response.json())
            .then(data => {
                const sessionsList = document.getElementById('sessions-list');
                sessionsList.innerHTML = '';
                
                if (data.sessions.length === 0) {
                    sessionsList.innerHTML = '<div class="list-group-item text-center text-muted">چتی وجود ندارد</div>';
                    return;
                }
                
                data.sessions.forEach(session => {
                    const sessionElement = document.createElement('div');
                    sessionElement.className = 'list-group-item session-item';
                    if (session.id == currentSessionId) {
                        sessionElement.classList.add('active');
                    }
                    sessionElement.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${session.title}</strong>
                                <div class="small text-muted">
                                    ${session.session_name} 
                                    <span class="model-access ${session.model_access.toLowerCase()}">
                                        ${session.model_access === 'Free' ? 'رایگان' : 'ویژه'}
                                    </span>
                                </div>
                            </div>
                            <div class="text-muted small">${new Date(session.updated_at).toLocaleTimeString()}</div>
                        </div>
                    `;
                    sessionElement.addEventListener('click', () => loadSession(session.id));
                    sessionsList.appendChild(sessionElement);
                });
            })
            .catch(error => console.error('Error loading sessions:', error));
    }
    
    // Load a specific session
    function loadSession(sessionId) {
        console.log('Loading session:', sessionId);
        currentSessionId = sessionId;
        loadSessions(); // Update active state
        
        // Update URL to reflect the current session
        const newUrl = `/chat/session/${sessionId}/`;
        history.pushState({sessionId: sessionId}, '', newUrl);
        
        fetch(`/chat/session/${sessionId}/messages/`)
            .then(response => response.json())
            .then(data => {
                console.log('Session data loaded:', data);
                document.getElementById('current-session-title').innerHTML = `
                    <i class="fas fa-comments"></i> ${data.session_title}
                `;
                document.getElementById('delete-session-btn').style.display = 'inline-block';
                
                const chatContainer = document.getElementById('chat-container');
                chatContainer.innerHTML = '';
                
                if (data.messages.length === 0) {
                    chatContainer.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-comment-slash"></i> هنوز پیامی وجود ندارد. مکالمه را شروع کنید!
                        </div>
                    `;
                } else {
                    data.messages.forEach(message => {
                        addMessageToChat(message);
                    });
                }
                
                // Enable input fields
                document.getElementById('message-input').disabled = false;
                document.getElementById('send-button').disabled = true; // Start disabled, enable when user types or selects image
                
                // Show/hide features section based on chatbot type
                const textFeaturesSection = document.getElementById('text-features-section');
                const imageUploadSection = document.getElementById('image-upload-section');
                if (data.chatbot_type === 'image') {
                    textFeaturesSection.style.display = 'none';
                    imageUploadSection.style.display = 'block';
                } else {
                    textFeaturesSection.style.display = 'block';
                    imageUploadSection.style.display = 'none';
                    // For text chatbots, enable send button when there's text
                    const messageInput = document.getElementById('message-input');
                    if (messageInput.value.trim()) {
                        document.getElementById('send-button').disabled = false;
                    }
                }
                
                // Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Focus on input
                document.getElementById('message-input').focus();
                
                // Hide sidebar on mobile after selecting a session
                if (window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.add('hidden');
                    document.querySelector('.overlay').classList.remove('show');
                }
            })
            .catch(error => console.error('Error loading session:', error));
    }

    // Add message to chat display
    function addMessageToChat(message) {
        const chatContainer = document.getElementById('chat-container');
        const welcomeMessage = document.getElementById('welcome-message');
        if (welcomeMessage) {
            welcomeMessage.remove();
        }
        
        const messageElement = document.createElement('div');
        messageElement.className = `message-${message.type}`;
        
        let content = `<strong>${message.type === 'user' ? 'شما' : 'دستیار'}:</strong> ${message.content}`;
        
        // Handle image URLs in messages
        if (message.image_url) {
            // Check if this is a data URL (base64) or a regular URL
            if (message.image_url.startsWith('data:')) {
                // For base64 images, display directly
                content += `<br><img src="${message.image_url}" class="image-preview" alt="تصویر تولید شده">`;
            } else if (message.image_url.startsWith('http')) {
                // For regular URLs, display directly
                // Add a data attribute to store the image URL for modification
                content += `<br><img src="${message.image_url}" class="image-preview" alt="تصویر تولید شده" data-image-url="${message.image_url}">`;
                // Add a modify button for assistant-generated images
                if (message.type === 'assistant') {
                    content += `<br><button class="btn btn-sm btn-outline-primary mt-2 modify-image-btn" data-image-url="${message.image_url}">اصلاح تصویر</button>`;
                }
            } else {
                // For user uploaded images (object URLs), display directly
                content += `<br><img src="${message.image_url}" class="image-preview" alt="تصویر آپلود شده">`;
            }
        }
        
        messageElement.innerHTML = content;
        chatContainer.appendChild(messageElement);
        
        // Add event listener for modify image buttons
        const modifyButtons = messageElement.querySelectorAll('.modify-image-btn');
        modifyButtons.forEach(button => {
            button.addEventListener('click', function() {
                const imageUrl = this.getAttribute('data-image-url');
                // Pre-fill the prompt input with a modification request
                const messageInput = document.getElementById('message-input');
                messageInput.value = `لطفاً این تصویر را اصلاح کن: ${imageUrl}`;
                messageInput.focus();
                
                // Show a notification to the user
                const notification = document.createElement('div');
                notification.className = 'alert alert-info mt-2';
                notification.innerHTML = 'برای اصلاح تصویر، توضیحات خود را در پیام اضافه کنید و ارسال کنید.';
                messageElement.appendChild(notification);
                
                // Remove notification after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 5000);
            });
        });
        
        // Scroll to bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Show typing indicator
    function showTypingIndicator() {
        const chatContainer = document.getElementById('chat-container');
        const welcomeMessage = document.getElementById('welcome-message');
        if (welcomeMessage) {
            welcomeMessage.remove();
        }
        
        const typingElement = document.createElement('div');
        typingElement.className = 'typing-indicator';
        typingElement.id = 'typing-indicator';
        typingElement.innerHTML = '<span></span><span></span><span></span>';
        chatContainer.appendChild(typingElement);
        
        // Scroll to bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Hide typing indicator
    function hideTypingIndicator() {
        const typingElement = document.getElementById('typing-indicator');
        if (typingElement) {
            typingElement.remove();
        }
    }
    
    // Send message with streaming support
    function sendMessage() {
        console.log('Sending message');
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();
        
        if (!message || !currentSessionId) return;
        
        // Check if web search is requested
        const webSearchBtn = document.getElementById('web-search-btn');
        const isWebSearch = webSearchBtn && webSearchBtn.classList.contains('active');
        console.log('Web search requested:', isWebSearch);
        
        // Check if PDF is uploaded
        const pdfInput = document.getElementById('pdf-input');
        const pdfUrlInput = document.getElementById('pdf-url-input');
        const pdfFile = pdfInput.files[0];
        const pdfUrl = pdfUrlInput.value.trim();
        console.log('PDF file:', pdfFile);
        console.log('PDF URL:', pdfUrl);
        
        // Check if PDF engine is selected
        const pdfEngineSelect = document.getElementById('pdf-engine-select');
        const pdfUrlEngineSelect = document.getElementById('pdf-url-engine-select');
        const pdfEngine = pdfFile ? pdfEngineSelect.value : pdfUrlEngineSelect.value;
        console.log('PDF engine:', pdfEngine);
        
        // Validate PDF inputs
        if (pdfFile && pdfUrl) {
            alert('لطفاً یا یک فایل PDF آپلود کنید یا آدرس PDF را وارد کنید، نه هر دو.');
            return;
        }
        
        // Add user message to chat immediately
        let userMessageContent = message;
        if (isWebSearch) {
            userMessageContent += " (با استفاده از جستجوی وب)";
        }
        if (pdfFile || pdfUrl) {
            userMessageContent += " (با پردازش فایل PDF)";
        }
        
        addMessageToChat({
            type: 'user',
            content: userMessageContent
        });
        
        // Clear inputs
        messageInput.value = '';
        
        // Reset web search button
        if (webSearchBtn) {
            webSearchBtn.classList.remove('active');
            webSearchBtn.classList.add('btn-outline-info');
            webSearchBtn.classList.remove('btn-info');
        }
        
        // Hide PDF upload containers
        document.getElementById('pdf-upload-container').style.display = 'none';
        document.getElementById('pdf-url-container').style.display = 'none';
        
        // Clear PDF inputs
        pdfInput.value = '';
        pdfUrlInput.value = '';
        
        // Remove file name element if exists
        const fileNameElement = document.getElementById('pdf-file-name');
        if (fileNameElement) {
            fileNameElement.remove();
        }
        
        // Disable input while processing
        messageInput.disabled = true;
        document.getElementById('send-button').disabled = true;
        
        // Hide image preview if it exists
        const previewContainer = document.getElementById('image-preview-container');
        if (previewContainer) {
            previewContainer.style.display = 'none';
        }
        // Clear image input if it exists
        const imageInput = document.getElementById('image-input');
        if (imageInput) {
            imageInput.value = '';
        }
        
        // Show typing indicator
        showTypingIndicator();
        
        // For streaming response
        let assistantContent = '';
        
        // Prepare request data
        const requestData = {
            message: message,
            web_search: isWebSearch
        };
        
        // Add PDF data if provided
        if (pdfFile) {
            requestData.pdf_engine = pdfEngine;
        } else if (pdfUrl) {
            requestData.pdf_url = pdfUrl;
            requestData.pdf_engine = pdfEngine;
        }
        
        // For PDF file upload, we need to use FormData
        let fetchOptions = {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        };
        
        if (pdfFile) {
            // Use FormData for file upload
            const formData = new FormData();
            formData.append('message', message);
            formData.append('web_search', isWebSearch);
            formData.append('pdf_file', pdfFile);
            formData.append('pdf_engine', pdfEngine);
            fetchOptions.body = formData;
            // Remove Content-Type header for FormData (browser will set it with boundary)
            delete fetchOptions.headers['Content-Type'];
        } else {
            // Use JSON for regular requests
            fetchOptions.headers['Content-Type'] = 'application/json';
            fetchOptions.body = JSON.stringify(requestData);
        }
        
        fetch(`/chat/session/${currentSessionId}/send/`, fetchOptions)
        .then(response => {
            if (!response.ok) {
                hideTypingIndicator();
                return response.json().then(data => {
                    throw new Error(data.error || 'Error sending message');
                });
            }
            
            // Check if response is streaming
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('text/plain')) {
                // Handle streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                
                function read() {
                    reader.read().then(({done, value}) => {
                        if (done) {
                            // Remove the temporary streaming element
                            const streamingElement = document.getElementById('streaming-assistant');
                            if (streamingElement) {
                                streamingElement.remove();
                            }
                            
                            // Save the complete message
                            addMessageToChat({
                                type: 'assistant',
                                content: assistantContent
                            });
                            hideTypingIndicator();
                            return;
                        }
                        
                        // Process the chunk with proper UTF-8 decoding
                        try {
                            const chunk = new TextDecoder('utf-8').decode(value);
                            assistantContent += chunk;
                            
                            // Update the last assistant message or create new one
                            updateOrAddAssistantMessage(assistantContent);
                        } catch (decodeError) {
                            console.error('Decoding error:', decodeError);
                            // Try with different encoding as fallback
                            try {
                                const chunk = new TextDecoder('latin-1').decode(value);
                                assistantContent += chunk;
                                updateOrAddAssistantMessage(assistantContent);
                            } catch (fallbackError) {
                                console.error('Fallback decoding error:', fallbackError);
                            }
                        }
                        
                        // Continue reading
                        read();
                    }).catch(error => {
                        hideTypingIndicator();
                        const streamingElement = document.getElementById('streaming-assistant');
                        if (streamingElement) {
                            streamingElement.remove();
                        }
                        console.error('Streaming error:', error);
                        addMessageToChat({
                            type: 'assistant',
                            content: `خطا: ${error.message || 'خطای نامشخص'}`
                        });
                    });
                }
                
                // Start reading the stream
                read();
            } else {
                // Handle regular JSON response
                hideTypingIndicator();
                return response.json().then(data => {
                    addMessageToChat({
                        type: 'assistant',
                        content: data.content,
                        image_url: data.image_url
                    });
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            hideTypingIndicator();
            
            let errorMessage = 'خطایی رخ داد';
            if (error.message) {
                errorMessage = error.message;
            } else if (typeof error === 'string') {
                errorMessage = error;
            } else if (typeof error === 'object') {
                try {
                    errorMessage = JSON.stringify(error);
                } catch (e) {
                    errorMessage = 'خطای نامشخص';
                }
            }
            
            addMessageToChat({
                type: 'assistant',
                content: `خطا: ${errorMessage}`
            });
        })
        .finally(() => {
            // Re-enable input
            messageInput.disabled = false;
            document.getElementById('send-button').disabled = false;
            messageInput.focus();
        });
    }
    
    // Update or add assistant message for streaming
    function updateOrAddAssistantMessage(content) {
        const chatContainer = document.getElementById('chat-container');
        let assistantElement = document.getElementById('streaming-assistant');
        
        if (!assistantElement) {
            // Create new assistant message element
            assistantElement = document.createElement('div');
            assistantElement.className = 'message-assistant';
            assistantElement.id = 'streaming-assistant';
            assistantElement.innerHTML = `<strong>دستیار:</strong> ${content}`;
            chatContainer.appendChild(assistantElement);
        } else {
            // Update existing element
            assistantElement.innerHTML = `<strong>دستیار:</strong> ${content}`;
        }
        
        // Scroll to bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Generate chat title using AI
    function generateChatTitle(firstMessage, chatbotId, modelId) {
        const data = {
            first_message: firstMessage,
            chatbot_id: chatbotId,
            model_id: modelId
        };
        
        return fetch('{% url "generate_chat_title" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => data.title || 'چت جدید');
    }
    
    // Create new chat
    async function createNewChat() {
        const chatbotId = document.getElementById('modal-chatbot-select').value;
        const modelId = document.getElementById('modal-model-select').value;
        
        // Validate selections
        if (!chatbotId || !modelId) {
            alert('لطفاً هم یک چت‌بات و هم یک مدل هوش مصنوعی انتخاب کنید');
            return;
        }
        
        let title = 'چت جدید';
        try {
            // Generate a title based on the chatbot and model
            title = `${document.getElementById('modal-chatbot-select').options[document.getElementById('modal-chatbot-select').selectedIndex].text} - ${new Date().toLocaleDateString('fa-IR')}`;
        } catch (error) {
            console.error('Error generating title:', error);
        }
        
        fetch('{% url "create_session" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                title: title,
                chatbot_id: chatbotId,
                ai_model_id: modelId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('خطا: ' + data.error);
                return;
            }
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('newChatModal')).hide();
            
            // Load the new session
            loadSession(data.session_id);
            
            // Refresh sessions list
            loadSessions();
            
            // Show/hide features sections based on chatbot type
            const textFeaturesSection = document.getElementById('text-features-section');
            const imageUploadSection = document.getElementById('image-upload-section');
            if (data.chatbot_type === 'image') {
                textFeaturesSection.style.display = 'none';
                imageUploadSection.style.display = 'block';
            } else {
                textFeaturesSection.style.display = 'block';
                imageUploadSection.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error creating chat:', error);
            alert('خطا در ایجاد چت: ' + error.message);
        });
    }
    
    // Delete session
    function deleteSession() {
        if (!currentSessionId) return;
        
        if (confirm('آیا مطمئن هستید که می‌خواهید این جلسه چت را حذف کنید؟')) {
            // Send DELETE request to remove the session
            fetch(`/chat/session/${currentSessionId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                if (response.ok) {
                    // Reset UI
                    currentSessionId = null;
                    document.getElementById('current-session-title').innerHTML = `
                        <i class="fas fa-comments"></i> چت را انتخاب کنید یا جدیدی ایجاد کنید
                    `;
                    document.getElementById('chat-container').innerHTML = `
                        <div class="text-center text-muted welcome-message" id="welcome-message">
                            <i class="fas fa-robot fa-3x mb-3"></i>
                            <h4>به چت‌بات MobixAI خوش آمدید</h4>
                            <p class="mb-0">چتی را انتخاب کنید یا چت جدیدی شروع کنید</p>
                        </div>
                    `;
                    document.getElementById('message-input').disabled = true;
                    document.getElementById('send-button').disabled = true;
                    document.getElementById('delete-session-btn').style.display = 'none';
                    loadSessions();
                    
                    // Hide sidebar on mobile
                    if (window.innerWidth < 768) {
                        document.getElementById('sidebar').classList.add('hidden');
                        document.querySelector('.overlay').classList.remove('show');
                    }
                } else {
                    alert('خطا در حذف چت');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('خطا در حذف چت');
            });
        }
    }
    
    // Check if both chatbot and model are selected in modal
    function checkModalSelections() {
        const chatbotSelect = document.getElementById('modal-chatbot-select');
        const modelSelect = document.getElementById('modal-model-select');
        const createBtn = document.getElementById('create-chat-btn');
        
        const chatbotSelected = chatbotSelect.value;
        const modelSelected = modelSelect.value;
        
        // Both chatbot and model must be selected
        if (chatbotSelected && modelSelected) {
            createBtn.disabled = false;
        } else {
            createBtn.disabled = true;
        }
    }
    
    // Check if both chatbot and model are selected in sidebar
    function checkSidebarSelections() {
        const chatbotSelect = document.getElementById('chatbot-select');
        const startBtn = document.getElementById('start-chat-btn');
        
        const chatbotSelected = chatbotSelect.value;
        
        // Chatbot must be selected
        if (chatbotSelected) {
            startBtn.disabled = false;
        } else {
            startBtn.disabled = true;
        }
    }
    
    // Toggle sidebar on mobile
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.overlay');
        
        sidebar.classList.toggle('hidden');
        if (overlay) {
            overlay.classList.toggle('show');
        }
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        loadSessions();
        
        // New chat button opens modal
        document.getElementById('new-chat-btn').addEventListener('click', function() {
            document.getElementById('modal-chatbot-select').value = '';
            document.getElementById('modal-model-select').value = '';
            document.getElementById('create-chat-btn').disabled = true;
            const modal = new bootstrap.Modal(document.getElementById('newChatModal'));
            modal.show();
        });
        
        // Modal selection change listeners
        document.getElementById('modal-chatbot-select').addEventListener('change', function() {
            checkModalSelections();
            // Load models based on chatbot type
            const chatbotId = this.value;
            if (chatbotId) {
                loadModelsForChatbot(chatbotId);
            }
        });
        document.getElementById('modal-model-select').addEventListener('change', checkModalSelections);
        
        // Sidebar selection change listeners
        document.getElementById('chatbot-select').addEventListener('change', function() {
            checkSidebarSelections();
            // If chatbot has a default model, pre-select it
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption && selectedOption.dataset.hasModel === 'true') {
                // We could pre-select the model here if needed
            }
        });
        
        // Modal create button
        document.getElementById('create-chat-btn').addEventListener('click', createNewChat);
        
        // Sidebar start button
        document.getElementById('start-chat-btn').addEventListener('click', function() {
            // Copy selections to modal and open it
            document.getElementById('modal-chatbot-select').value = document.getElementById('chatbot-select').value;
            // For sidebar, we need to get the selected model from the modal
            checkModalSelections();
            const modal = new bootstrap.Modal(document.getElementById('newChatModal'));
            modal.show();
        });
        
        // Send message button
        document.getElementById('send-button').addEventListener('click', function() {
            // Check if this is an image generation chatbot and there's an image selected
            const imageUploadSection = document.getElementById('image-upload-section');
            const imageInput = document.getElementById('image-input');
            
            if (imageUploadSection.style.display !== 'none' && imageInput.files.length > 0) {
                // This is an image chatbot with an image selected, use image upload
                uploadImage();
            } else {
                // Regular text message with possible web search or PDF
                sendMessage();
            }
        });
        
        // Enter key in message input
        document.getElementById('message-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                // Check if this is an image generation chatbot and there's an image selected
                const imageUploadSection = document.getElementById('image-upload-section');
                const imageInput = document.getElementById('image-input');
                
                if (imageUploadSection.style.display !== 'none' && imageInput.files.length > 0) {
                    // This is an image chatbot with an image selected, use image upload
                    uploadImage();
                } else {
                    // Regular text message with possible web search or PDF
                    sendMessage();
                }
            }
        });
        
        // Delete session button
        document.getElementById('delete-session-btn').addEventListener('click', deleteSession);
        
        // Mobile sidebar toggle
        if (document.getElementById('toggle-sidebar')) {
            document.getElementById('toggle-sidebar').addEventListener('click', toggleSidebar);
        }
        
        if (document.getElementById('open-sidebar-mobile')) {
            document.getElementById('open-sidebar-mobile').addEventListener('click', toggleSidebar);
        }
        
        // Add event listener for image upload button
        document.getElementById('upload-image-btn').addEventListener('click', uploadImage);
        
        // Add event listener for image input to enable/disable send button and show preview
        document.getElementById('image-input').addEventListener('change', function() {
            const sendBtn = document.getElementById('send-button');
            const previewContainer = document.getElementById('image-preview-container');
            const previewImage = document.getElementById('image-preview');
            const messageInput = document.getElementById('message-input');
            
            if (this.files && this.files[0]) {
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewContainer.style.display = 'block';
                }
                reader.readAsDataURL(this.files[0]);
                
                // Enable send button if there's a message or an image
                if (messageInput.value.trim() || this.files.length > 0) {
                    sendBtn.disabled = false;
                }
            } else {
                previewContainer.style.display = 'none';
                // Disable send button if no message and no image
                if (!messageInput.value.trim()) {
                    sendBtn.disabled = true;
                }
            }
        });
        
        // Add event listener for remove image button
        if (document.getElementById('remove-image-btn')) {
            document.getElementById('remove-image-btn').addEventListener('click', function() {
                const imageInput = document.getElementById('image-input');
                const sendBtn = document.getElementById('send-button');
                const previewContainer = document.getElementById('image-preview-container');
                const messageInput = document.getElementById('message-input');
                
                // Clear the input and hide preview
                imageInput.value = '';
                previewContainer.style.display = 'none';
                
                // Disable send button if no message
                if (!messageInput.value.trim()) {
                    sendBtn.disabled = true;
                }
            });
        }
        
        // Add event listener for PDF input to show file name and enable send button
        if (document.getElementById('pdf-input')) {
            document.getElementById('pdf-input').addEventListener('change', function() {
                console.log('PDF input changed');
                const sendBtn = document.getElementById('send-button');
                const messageInput = document.getElementById('message-input');
                const pdfFile = this.files[0];
                
                if (pdfFile) {
                    console.log('PDF file selected:', pdfFile);
                    // Check if file is PDF
                    if (pdfFile.type !== 'application/pdf' && !pdfFile.name.toLowerCase().endsWith('.pdf')) {
                        alert('لطفاً یک فایل PDF معتبر انتخاب کنید.');
                        this.value = '';
                        return;
                    }
                    
                    // Check file size (limit to 10MB)
                    if (pdfFile.size > 10 * 1024 * 1024) {
                        alert('حجم فایل بیش از حد مجاز است. حداکثر 10 مگابایت.');
                        this.value = '';
                        return;
                    }
                    
                    // Show file name
                    const fileName = pdfFile.name;
                    const fileNameElement = document.createElement('div');
                    fileNameElement.className = 'mt-2 text-muted small';
                    fileNameElement.id = 'pdf-file-name';
                    fileNameElement.innerHTML = `<i class="fas fa-file-pdf"></i> ${fileName}`;
                    
                    // Remove existing file name element if exists
                    const existingFileNameElement = document.getElementById('pdf-file-name');
                    if (existingFileNameElement) {
                        existingFileNameElement.remove();
                    }
                    
                    // Add file name element after the input group
                    this.parentElement.parentElement.appendChild(fileNameElement);
                    
                    // Enable send button if there's a message or a PDF file
                    if (messageInput.value.trim() || this.files.length > 0) {
                        sendBtn.disabled = false;
                    }
                } else {
                    console.log('No PDF file selected');
                    // Remove file name element if exists
                    const fileNameElement = document.getElementById('pdf-file-name');
                    if (fileNameElement) {
                        fileNameElement.remove();
                    }
                    
                    // Disable send button if no message and no PDF
                    if (!messageInput.value.trim()) {
                        sendBtn.disabled = true;
                    }
                }
            });
        }
        
        // Add event listeners for web search and PDF features
        if (document.getElementById('web-search-btn')) {
            document.getElementById('web-search-btn').addEventListener('click', function() {
                console.log('Web search button clicked');
                // Check if current model supports web search
                checkWebSearchSupport();
            });
        }
        
        if (document.getElementById('pdf-upload-btn')) {
            document.getElementById('pdf-upload-btn').addEventListener('click', function() {
                console.log('PDF upload button clicked');
                const pdfUploadContainer = document.getElementById('pdf-upload-container');
                const pdfUrlContainer = document.getElementById('pdf-url-container');
                
                // Toggle PDF upload container
                if (pdfUploadContainer.style.display === 'none') {
                    pdfUploadContainer.style.display = 'block';
                    pdfUrlContainer.style.display = 'none';
                    
                    // Focus on the file input to trigger file selection
                    const pdfInput = document.getElementById('pdf-input');
                    if (pdfInput) {
                        console.log('Triggering PDF input click');
                        pdfInput.click();
                    }
                } else {
                    pdfUploadContainer.style.display = 'none';
                }
            });
        }
        
        if (document.getElementById('pdf-url-btn')) {
            document.getElementById('pdf-url-btn').addEventListener('click', function() {
                const pdfUploadContainer = document.getElementById('pdf-upload-container');
                const pdfUrlContainer = document.getElementById('pdf-url-container');
                
                // Show URL input, hide file input
                pdfUrlContainer.style.display = 'block';
                pdfUploadContainer.style.display = 'none';
            });
        }
        
        if (document.getElementById('pdf-file-btn')) {
            document.getElementById('pdf-file-btn').addEventListener('click', function() {
                const pdfUploadContainer = document.getElementById('pdf-upload-container');
                const pdfUrlContainer = document.getElementById('pdf-url-container');
                
                // Show file input, hide URL input
                pdfUploadContainer.style.display = 'block';
                pdfUrlContainer.style.display = 'none';
            });
        }
        
        // Create overlay for mobile
        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        document.body.appendChild(overlay);
        overlay.addEventListener('click', toggleSidebar);
        
        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.sessionId) {
                loadSession(event.state.sessionId);
            } else {
                // Reset to default state
                currentSessionId = null;
                document.getElementById('current-session-title').innerHTML = `
                    <i class="fas fa-comments"></i> چت را انتخاب کنید یا جدیدی ایجاد کنید
                `;
                document.getElementById('chat-container').innerHTML = `
                    <div class="text-center text-muted welcome-message" id="welcome-message">
                        <i class="fas fa-robot fa-3x mb-3"></i>
                        <h4>به چت‌بات MobixAI خوش آمدید</h4>
                        <p class="mb-0">چتی را انتخاب کنید یا چت جدیدی شروع کنید</p>
                    </div>
                `;
                document.getElementById('message-input').disabled = true;
                document.getElementById('send-button').disabled = true;
                document.getElementById('delete-session-btn').style.display = 'none';
            }
        });
    });
    
    // Load models for a specific chatbot based on its type
    function loadModelsForChatbot(chatbotId) {
        fetch(`/chat/chatbot/${chatbotId}/models/`)
            .then(response => response.json())
            .then(data => {
                const modelSelect = document.getElementById('modal-model-select');
                modelSelect.innerHTML = '<option value="">-- مدلی را انتخاب کنید --</option>';
                
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.model_id;
                    option.textContent = model.name;
                    option.dataset.isFree = model.is_free;
                    
                    // Add badge for free/premium models
                    if (model.is_free) {
                        option.innerHTML += ' <span class="badge bg-success">رایگان</span>';
                    } else {
                        option.innerHTML += ' <span class="badge bg-warning">ویژه</span>';
                    }
                    
                    modelSelect.appendChild(option);
                });
                
                // Enable or disable the model select based on whether there are models
                modelSelect.disabled = data.models.length === 0;
            })
            .catch(error => {
                console.error('Error loading models:', error);
            });
    }
    
    // Upload image function for image generation chatbots
    function uploadImage() {
        if (!currentSessionId) {
            alert('لطفاً ابتدا یک جلسه چت ایجاد کنید');
            return;
        }
        
        const imageInput = document.getElementById('image-input');
        const messageInput = document.getElementById('message-input');
        const previewContainer = document.getElementById('image-preview-container');
        
        // For image generation, either image or text prompt is required
        if (!imageInput.files.length && !messageInput.value.trim()) {
            alert('لطفاً یک تصویر یا متن توضیحی وارد کنید');
            return;
        }
        
        const imageFile = imageInput.files[0];
        let prompt = messageInput.value.trim();
        
        // Check if this is a modification request for a previously generated image
        let modifyImageUrl = null;
        if (prompt.includes('لطفاً این تصویر را اصلاح کن: http')) {
            // Extract the image URL from the prompt
            const urlMatch = prompt.match(/لطفاً این تصویر را اصلاح کن: (http[^\s]+)/);
            if (urlMatch && urlMatch[1]) {
                modifyImageUrl = urlMatch[1];
                // Remove the URL from the prompt to get the actual modification request
                prompt = prompt.replace(/لطفاً این تصویر را اصلاح کن: http[^\s]+/, '').trim();
            }
        }
        
        // Show uploading indicator
        showTypingIndicator();
        
        // Disable inputs during upload
        imageInput.disabled = true;
        messageInput.disabled = true;
        document.getElementById('send-button').disabled = true;
        if (document.getElementById('remove-image-btn')) {
            document.getElementById('remove-image-btn').disabled = true;
        }
        
        // Create FormData object to send file and prompt
        const formData = new FormData();
        if (imageFile) {
            formData.append('image', imageFile);
        }
        if (prompt) {
            formData.append('prompt', prompt);
        }
        // If this is a modification request, include the image URL
        if (modifyImageUrl) {
            formData.append('modify_image_url', modifyImageUrl);
        }
        
        // Send image to server
        fetch(`/chat/session/${currentSessionId}/send-image/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Error uploading image');
                });
            }
            return response.json();
        })
        .then(data => {
            hideTypingIndicator();
            
            // Add user message to chat with image preview
            if (prompt || imageFile) {
                const messageData = {
                    type: 'user',
                    content: prompt || 'تصویر ارسال شد'
                };
                
                if (imageFile) {
                    const imageUrl = URL.createObjectURL(imageFile);
                    messageData.image_url = imageUrl;
                } else if (modifyImageUrl) {
                    // For modification requests, show the image being modified
                    messageData.image_url = modifyImageUrl;
                }
                
                addMessageToChat(messageData);
            }
            
            // Add assistant response to chat
            addMessageToChat({
                type: 'assistant',
                content: data.content,
                image_url: data.image_urls && data.image_urls.length > 0 ? data.image_urls[0] : null
            });
            
            // Clear inputs and hide preview
            imageInput.value = '';
            messageInput.value = '';
            if (previewContainer) {
                previewContainer.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            hideTypingIndicator();
            
            let errorMessage = 'خطایی رخ داد';
            if (error.message) {
                errorMessage = error.message;
            } else if (typeof error === 'string') {
                errorMessage = error;
            } else if (typeof error === 'object') {
                try {
                    errorMessage = JSON.stringify(error);
                } catch (e) {
                    errorMessage = 'خطای نامشخص';
                }
            }
            
            addMessageToChat({
                type: 'assistant',
                content: `خطا: ${errorMessage}`
            });
        })
        .finally(() => {
            // Re-enable inputs
            imageInput.disabled = false;
            messageInput.disabled = false;
            document.getElementById('send-button').disabled = false;
            if (document.getElementById('remove-image-btn')) {
                document.getElementById('remove-image-btn').disabled = false;
            }
            messageInput.focus();
        });
    }
    
    // Add a function to check if current session is for image generation
    function checkSessionType() {
        if (!currentSessionId) return;
        
        // This function is not needed as the image upload section visibility is 
        // already handled in loadSession and createNewChat functions
        // Removing this function to prevent it from overriding the correct visibility
        return;
    }

    // Check if the current model supports web search
    function checkWebSearchSupport() {
        console.log('Checking web search support');
        if (!currentSessionId) {
            alert('لطفاً ابتدا یک جلسه چت ایجاد کنید');
            return;
        }
        
        // Get the current session info to check model support
        fetch(`/chat/session/${currentSessionId}/messages/`)
            .then(response => response.json())
            .then(data => {
                console.log('Session data:', data);
                // Check if the model supports web search
                // Models with :online suffix or openrouter/auto models support web search
                const aiModelId = data.ai_model_id;
                
                if (aiModelId && (aiModelId.includes(':online') || aiModelId.startsWith('openrouter/auto'))) {
                    console.log('Model supports web search:', aiModelId);
                    // Model supports web search, toggle the button
                    const webSearchBtn = document.getElementById('web-search-btn');
                    if (webSearchBtn) {
                        webSearchBtn.classList.toggle('active');
                        if (webSearchBtn.classList.contains('active')) {
                            webSearchBtn.classList.remove('btn-outline-info');
                            webSearchBtn.classList.add('btn-info');
                        } else {
                            webSearchBtn.classList.remove('btn-info');
                            webSearchBtn.classList.add('btn-outline-info');
                        }
                    }
                } else {
                    console.log('Model does not support web search:', aiModelId);
                    // Model doesn't support web search
                    alert('مدل انتخاب‌شده قابلیت جستجوی وب ندارد');
                }
            })
            .catch(error => {
                console.error('Error checking model support:', error);
                // Show error to user
                alert('خطا در بررسی پشتیبانی مدل از جستجوی وب');
            });
    }

    // Enable/disable send button based on message content or image selection
    document.getElementById('message-input').addEventListener('input', function() {
        const sendBtn = document.getElementById('send-button');
        const imageInput = document.getElementById('image-input');
        
        // Enable send button if there's a message or an image selected
        if (this.value.trim() || (imageInput && imageInput.files.length > 0)) {
            sendBtn.disabled = false;
        } else {
            sendBtn.disabled = true;
        }
    });

</script>
{% endblock %}