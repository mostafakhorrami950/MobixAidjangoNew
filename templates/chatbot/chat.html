{% extends 'base.html' %}

{% block content %}
<div class="chatgpt-container">
    <div class="chatgpt-layout">
        <!-- Sidebar - Collapsible on mobile -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h5 class="mb-0">چت‌های من</h5>
                <div class="sidebar-controls">
                    <button class="btn btn-sm btn-light" id="toggle-sessions" title="جمع/باز کردن چت‌ها">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                    <button class="btn btn-sm btn-light d-md-none" id="toggle-sidebar" title="بستن/باز کردن منو">
                        <i class="fas fa-times"></i>
                    </button>
                    <button class="btn btn-sm btn-light" id="new-chat-btn" title="چت جدید">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="sessions-container" id="sessions-container">
                <div class="list-group sessions-list" id="sessions-list">
                    <!-- Sessions will be loaded here -->
                </div>
            </div>
            
            <!-- Desktop Navigation Menu -->
            <div class="desktop-nav-menu d-none d-md-block" id="desktop-nav-menu">
                <!-- Menu items will be loaded here dynamically -->
            </div>
            
            <!-- Mobile Navigation Menu -->
            <div class="mobile-nav-menu d-md-none" id="mobile-nav-menu">
                <!-- Menu items will be loaded here dynamically -->
            </div>
            
            <!-- Available Chatbots - REMOVED as per requirements -->
        </div>
        
        <!-- Main Chat Area -->
        <div class="main-content" id="main-content">

            
            <!-- Floating Model Selection Component -->
            <div class="floating-model-selection" id="floating-model-selection">
                <div class="model-selection-header">
                    <h6 class="mb-0">انتخاب مدل هوش مصنوعی</h6>
                    <button class="btn btn-sm btn-close" id="close-model-selection" aria-label="بستن"><i class="fas fa-times"></i></button>
                </div>
                <div class="model-grid" id="model-grid">
                    <!-- Models will be loaded here dynamically -->
                </div>
            </div>
            
            <div class="chat-messages-container">
                <div id="chat-container" class="chat-messages">
                    <div class="welcome-message" id="welcome-message">
                        <i class="fas fa-robot fa-3x mb-3"></i>
                        <h4>به چت‌بات MobixAI خوش آمدید</h4>
                        <p class="mb-0">چتی را انتخاب کنید یا چت جدیدی شروع کنید</p>
                        
                        <!-- Web search toggle for new session -->
                        <div class="web-search-toggle-container mt-3" id="welcome-web-search-container" style="display: none;">
                            <button class="btn btn-outline-secondary" id="welcome-web-search-btn" type="button">
                                <i class="fas fa-search"></i> جستجو وب
                            </button>
                            <small class="text-muted d-block mt-1">
                                فعال کردن جستجوی اینترنتی برای پاسخ‌های به‌روز
                            </small>
                        </div>
                    </div>
                    <!-- Chat messages will appear here -->
                </div>
            </div>
            
            <!-- Web search button above input -->

            
            <div class="input-container">
                <div class="web-search-container">
                    <button class="btn btn-sm btn-outline-secondary" id="web-search-btn" title="جستجو وب">
                        <i class="fas fa-search"></i> جستجو وب
                    </button>
                    <!-- Add image generation button -->
                    <button class="btn btn-sm btn-outline-primary" id="image-generation-btn" style="display: none;" title="تولید تصویر">
                        <i class="fas fa-image"></i> تولید تصویر
                    </button>

                </div>
                <form id="chat-form" class="position-relative">
                    <textarea class="form-control" id="message-input" placeholder="پیام خود را تایپ کنید..." rows="3"></textarea>
                    <!-- Hidden hint for image editing chatbot -->
                    <div class="image-merge-hint d-none position-absolute" id="image-merge-hint">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            برای ادغام با تصویر قبلی، کلمه "ادغام" یا "ترکیب" را بنویسید
                        </small>
                    </div>
                    <!-- Floating buttons -->
                    <div class="message-input-buttons">
                        <!-- Add file upload button -->
                        <button class="btn btn-secondary" type="button" id="upload-btn" title="آپلود فایل">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <!-- Hidden file input for multiple files - فایل انپوت مخفی برای چند فایل -->
                        <input type="file" id="file-input" multiple style="display: none;">
                        <button class="btn btn-primary" type="button" id="send-button" disabled>
                            <span class="send-icon">
                                <i class="fas fa-paper-plane"></i>
                            </span>
                            <span class="stop-icon" style="display: none;">
                                <i class="fas fa-stop"></i>
                            </span>
                        </button>
                    </div>
                </form>
                <!-- Multiple Files preview area - ناحیه پیشنمایش چندین فایل -->
                <div id="files-preview" class="files-preview mt-2" style="display: none;">
                    <div class="files-header d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">
                            <i class="fas fa-paperclip"></i> فایل‌های انتخابی (<span id="files-count">0</span>)
                        </span>
                        <button class="btn btn-sm btn-outline-danger" id="clear-all-files" title="حذف همه فایل‌ها">
                            <i class="fas fa-trash-alt"></i> پاک کردن همه
                        </button>
                    </div>
                    <div id="files-list" class="files-list">
                        <!-- Files will be added here dynamically -->
                    </div>
                </div>
                <div class="input-hint">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> Shift + Enter برای خط جدید | Enter برای ارسال
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Model Selection Wrapper as Floating Button -->
<div class="model-selection-wrapper" id="model-selection-button">
    <span class="model-select-label">مدل: </span>
    <span id="current-model-name">انتخاب مدل</span>
    <i class="fas fa-chevron-down ms-1"></i>
</div>

<!-- Overlay for mobile sidebar -->
<div class="overlay d-md-none" id="sidebar-overlay"></div>

<!-- Floating Action Button for Mobile -->
<div class="floating-action-button d-md-none" id="fab-new-chat">
    <button class="btn btn-primary rounded-circle shadow-lg" title="چت جدید">
        <i class="fas fa-plus"></i>
    </button>
</div>

<!-- New Chat Modal -->
<div class="modal fade" id="newChatModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content rounded-3 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title d-flex align-items-center">
                    <i class="fas fa-plus-circle me-2"></i>
                    <span>چت جدید</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4 text-center">
                    <p class="text-muted mb-0">چت جدیدی بسازید</p>
                </div>
                
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-light py-3">
                                <h6 class="mb-0 d-flex align-items-center">
                                    <i class="fas fa-robot text-primary me-2"></i>
                                    <span>چت‌بات</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">چت‌بات خود را انتخاب کنید</label>
                                    <select class="form-select form-select-lg" id="modal-chatbot-select">
                                        <option value="" selected>انتخاب چت‌بات...</option>
                                        {% for chatbot in available_chatbots %}
                                            <option value="{{ chatbot.id }}" 
                                                    data-has-model="true">
                                                {{ chatbot.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="alert alert-info d-flex align-items-center">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <small>هر چت‌بات تخصص خاصی دارد</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light py-3">
                                <h6 class="mb-0 d-flex align-items-center">
                                    <i class="fas fa-microchip text-success me-2"></i>
                                    <span>مدل AI</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">مدل هوش مصنوعی</label>
                                    <!-- Custom model selection dropdown -->
                                    <div class="custom-model-dropdown">
                                        <div class="model-dropdown-selected" id="model-dropdown-selected">
                                            <span class="placeholder-text">انتخاب مدل...</span>
                                            <i class="fas fa-chevron-down dropdown-arrow"></i>
                                        </div>
                                        <div class="model-dropdown-menu" id="model-dropdown-menu">
                                            <!-- Models will be loaded dynamically via JavaScript -->
                                        </div>
                                        <input type="hidden" id="modal-model-select" value="">
                                    </div>
                                </div>
                                <div class="alert alert-warning d-flex align-items-center">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <small>مدل انتخابی برای چت جدید استفاده می‌شود</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 p-3 bg-light rounded">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-lightbulb text-warning me-2"></i>
                        <h6 class="mb-0">نکات مهم</h6>
                    </div>
                    <ul class="mb-0 mt-2 small">
                        <li>چت‌بات‌ها برای کاربردهای خاص هستند</li>
                        <li>مدل‌های رایگان برای کارهای عمومی</li>
                        <li>مدل‌های ویژه برای پاسخ‌های بهتر</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    <span>لغو</span>
                </button>
                <button type="button" class="btn btn-primary" id="create-chat-btn" disabled>
                    <i class="fas fa-comment me-1"></i>
                    <span>ساخت چت</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- استایل‌های اضافی برای drag and drop -->
{% load static %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
<!-- JavaScript فایل‌های مجزا -->
{% load static %}
<!-- بارگذاری فایل‌های JavaScript به ترتیب صحیح -->
<script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
<script src="{% static 'chatbot/js/config.js' %}"></script>
<script src="{% static 'chatbot/js/utils.js' %}"></script>
<script>
    // تنظیم URL های Django بعد از بارگذاری utils.js
    const CHAT_URLS = {
        getUserSessions: '{% url "get_user_sessions" %}',
        createSession: '{% url "create_session" %}',
        createDefaultSession: '{% url "create_default_session" %}',
        generateChatTitle: '{% url "generate_chat_title" %}',
        getSidebarMenuItems: '{% url "get_sidebar_menu_items" %}'
    };
</script>
<script src="{% static 'chatbot/js/multifileupload.js' %}"></script>
<script src="{% static 'chatbot/js/sessions.js' %}"></script>
<script src="{% static 'chatbot/js/messages.js' %}"></script>
<script src="{% static 'chatbot/js/messaging.js' %}"></script>
<script src="{% static 'chatbot/js/features.js' %}"></script>
<script src="{% static 'chatbot/js/ui.js' %}"></script>
<script src="{% static 'chatbot/js/message_editing.js' %}"></script>
<script src="{% static 'chatbot/js/main.js' %}"></script>

{% endblock %}