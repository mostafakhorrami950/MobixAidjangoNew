{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h3>تست ساده استریمینگ</h3>
            <div id="chat-container" class="border p-3 mb-3" style="height: 400px; overflow-y: auto;">
                <div class="text-muted">پیام‌ها اینجا نمایش داده می‌شوند...</div>
            </div>
            <form id="chat-form" class="d-flex">
                <textarea class="form-control me-2" id="message-input" placeholder="پیام خود را تایپ کنید..." rows="2"></textarea>
                <button class="btn btn-primary" type="submit" id="send-button">ارسال</button>
            </form>
        </div>
    </div>
</div>

<script>
console.log('=== INLINE SCRIPT LOADED ===');

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOM LOADED ===');
    
    const form = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const chatContainer = document.getElementById('chat-container');
    
    console.log('Elements found:', {
        form: !!form,
        messageInput: !!messageInput,
        sendButton: !!sendButton,
        chatContainer: !!chatContainer
    });
    
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('=== FORM SUBMITTED ===');
            
            const message = messageInput.value.trim();
            if (!message) {
                console.log('Empty message');
                return;
            }
            
            console.log('Sending message:', message);
            
            // Add user message
            const userDiv = document.createElement('div');
            userDiv.className = 'mb-3';
            userDiv.innerHTML = `
                <div class="d-flex justify-content-end">
                    <div class="bg-primary text-white p-2 rounded" style="max-width: 70%;">
                        <strong>شما:</strong> ${message}
                    </div>
                </div>
            `;
            chatContainer.appendChild(userDiv);
            
            // Add loading message
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-message';
            loadingDiv.className = 'mb-3';
            loadingDiv.innerHTML = `
                <div class="d-flex justify-content-start">
                    <div class="bg-light p-2 rounded" style="max-width: 70%;">
                        <strong>دستیار:</strong> در حال تولید پاسخ...
                    </div>
                </div>
            `;
            chatContainer.appendChild(loadingDiv);
            
            messageInput.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Send request
            fetch('/chat/test-stream/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({message: message})
            })
            .then(response => {
                console.log('Response received:', response.ok);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                
                // Remove loading message
                const loading = document.getElementById('loading-message');
                if (loading) {
                    loading.remove();
                }
                
                // Add assistant response div
                const responseDiv = document.createElement('div');
                responseDiv.id = 'streaming-response';
                responseDiv.className = 'mb-3';
                responseDiv.innerHTML = `
                    <div class="d-flex justify-content-start">
                        <div class="bg-light p-2 rounded" style="max-width: 70%;">
                            <strong>دستیار:</strong> <span id="response-content"></span>
                        </div>
                    </div>
                `;
                chatContainer.appendChild(responseDiv);
                
                const responseContent = document.getElementById('response-content');
                
                function readStream() {
                    reader.read().then(({done, value}) => {
                        if (done) {
                            console.log('Stream finished. Full response:', fullResponse);
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                            return;
                        }
                        
                        const chunk = decoder.decode(value, {stream: true});
                        console.log('Chunk received:', chunk.substring(0, 50) + '...');
                        
                        fullResponse += chunk;
                        if (responseContent) {
                            responseContent.textContent = fullResponse;
                        }
                        
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                        readStream();
                    });
                }
                
                readStream();
            })
            .catch(error => {
                console.error('Error:', error);
                const loading = document.getElementById('loading-message');
                if (loading) {
                    loading.innerHTML = `
                        <div class="d-flex justify-content-start">
                            <div class="bg-danger text-white p-2 rounded" style="max-width: 70%;">
                                <strong>خطا:</strong> ${error.message}
                            </div>
                        </div>
                    `;
                }
            });
        });
    }
});

// CSRF Token function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}