{% extends 'base.html' %}

{% block content %}
<div class="chatgpt-container">
    <div class="chatgpt-layout">
        <!-- Sidebar - Collapsible on mobile -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h5 class="mb-0">چت‌های من</h5>
                <div class="sidebar-controls">
                    <button class="btn btn-sm btn-light" id="toggle-sessions" title="جمع/باز کردن چت‌ها">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                    <button class="btn btn-sm btn-light d-md-none" id="toggle-sidebar" title="بستن/باز کردن منو">
                        <i class="fas fa-times"></i>
                    </button>
                    <button class="btn btn-sm btn-light" id="new-chat-btn" title="چت جدید">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="sessions-container" id="sessions-container">
                <div class="list-group sessions-list" id="sessions-list">
                    <!-- Sessions will be loaded here -->
                </div>
            </div>
            
            <!-- Mobile Navigation Menu -->
            <div class="mobile-nav-menu d-md-none">
                <div class="nav-item">
                    <a class="nav-link" href="{% url 'chat' %}">
                        <i class="fas fa-comments"></i> چت
                    </a>
                </div>
                {% if user.is_authenticated %}
                    <div class="nav-item">
                        <a class="nav-link" href="{% url 'purchase_subscription' %}">
                            <i class="fas fa-shopping-cart"></i> خرید اشتراک
                        </a>
                    </div>
                    <div class="nav-item">
                        <a class="nav-link" href="{% url 'logout' %}">
                            <i class="fas fa-sign-out-alt"></i> خروج ({{ user.name }})
                        </a>
                    </div>
                {% else %}
                    <div class="nav-item">
                        <a class="nav-link" href="{% url 'login' %}">
                            <i class="fas fa-sign-in-alt"></i> ورود
                        </a>
                    </div>
                {% endif %}
            </div>
            
            <!-- Available Chatbots - REMOVED as per requirements -->
        </div>
        
        <!-- Main Chat Area -->
        <div class="main-content" id="main-content">
            <div class="chat-header">
                <h5 id="current-session-title">
                    <i class="fas fa-comments"></i> چت را انتخاب کنید یا جدیدی ایجاد کنید
                </h5>
                <div class="chat-header-actions">
                    <button class="btn btn-sm btn-danger" id="delete-session-btn" style="display: none;">
                        <i class="fas fa-trash"></i> حذف چت
                    </button>
                </div>
            </div>
            
            <div class="chat-messages-container">
                <div id="chat-container" class="chat-messages">
                    <div class="welcome-message" id="welcome-message">
                        <i class="fas fa-robot fa-3x mb-3"></i>
                        <h4>به چت‌بات MobixAI خوش آمدید</h4>
                        <p class="mb-0">چتی را انتخاب کنید یا چت جدیدی شروع کنید</p>
                    </div>
                    <!-- Chat messages will appear here -->
                </div>
            </div>
            
            <!-- Web search button above input -->

            
            <div class="input-container">
                <div class="web-search-container">
                    <button class="btn btn-sm btn-outline-secondary" id="web-search-btn" style="display: none;" title="جستجو وب">
                        <i class="fas fa-search"></i> جستجو وب
                    </button>
                    <!-- Add image generation button -->
                    <button class="btn btn-sm btn-outline-primary" id="image-generation-btn" style="display: none;" title="تولید تصویر">
                        <i class="fas fa-image"></i> تولید تصویر
                    </button>
                </div>
                <form id="chat-form" class="d-flex">
                    <div class="input-group">
                        <textarea class="form-control" id="message-input" placeholder="پیام خود را تایپ کنید..." rows="2" disabled></textarea>
                        <!-- Add file upload button -->
                        <button class="btn btn-secondary" type="button" id="upload-btn" title="آپلود فایل">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <!-- Hidden file input -->
                        <input type="file" id="file-input" style="display: none;">
                        <button class="btn btn-primary" type="button" id="send-button" disabled>
                            <span class="send-icon">
                                <i class="fas fa-paper-plane"></i> ارسال
                            </span>
                            <span class="stop-icon" style="display: none;">
                                <i class="fas fa-stop"></i> توقف
                            </span>
                        </button>
                    </div>
                </form>
                <!-- File preview area -->
                <div id="file-preview" class="file-preview mt-2" style="display: none;">
                    <div class="d-flex align-items-center bg-light p-2 rounded">
                        <i class="fas fa-file-image text-muted me-2"></i>
                        <span id="file-name" class="flex-grow-1 text-truncate"></span>
                        <button class="btn btn-sm btn-outline-danger" id="remove-file" title="حذف فایل">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="input-hint">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> Shift + Enter برای خط جدید | Enter برای ارسال
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Overlay for mobile sidebar -->
<div class="overlay d-md-none" id="sidebar-overlay"></div>

<!-- New Chat Modal -->
<div class="modal fade" id="newChatModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle"></i> ایجاد چت جدید
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="chatbot-selection-card">
                            <h6 class="mb-0">
                                <i class="fas fa-robot"></i> انتخاب چت‌بات
                            </h6>
                            <div class="mb-3">
                                <select class="form-select" id="modal-chatbot-select">
                                    <option value="">-- چت‌باتی را انتخاب کنید --</option>
                                    {% for chatbot in available_chatbots %}
                                        <option value="{{ chatbot.id }}" data-has-model="true">
                                            {{ chatbot.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="model-selection-card">
                            <h6 class="mb-0">
                                <i class="fas fa-microchip"></i> انتخاب مدل AI
                            </h6>
                            <div class="mb-3">
                                <select class="form-select" id="modal-model-select">
                                    <option value="">-- مدلی را انتخاب کنید --</option>
                                    {% for model in available_models %}
                                        <option value="{{ model.model_id }}" data-is-free="{{ model.is_free }}">
                                            {{ model.name }} 
                                            {% if model.is_free %}
                                                <span class="badge bg-success">رایگان</span>
                                            {% else %}
                                                <span class="badge bg-warning">ویژه</span>
                                            {% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i> 
                    توجه: شما باید یک چت‌بات انتخاب کنید. برخی چت‌بات‌ها نیاز به انتخاب مدل هوش مصنوعی دارند.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> لغو
                </button>
                <button type="button" class="btn btn-primary" id="create-chat-btn" disabled>
                    <i class="fas fa-comment"></i> ایجاد چت
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
<script>
    // Initialize markdown-it with enhanced configuration
    const md = window.markdownit({
        html: false,        // Disable HTML tags in source
        xhtmlOut: false,    // Use '/ >' in void tags
        breaks: true,       // Convert '\n' in paragraphs into <br>
        langPrefix: 'language-',  // CSS language prefix for fenced blocks
        linkify: true,      // Autoconvert URL-like text to links
        typographer: true,  // Enable some language-neutral replacement + quotes beautification
        quotes: ['\u201C', '\u201D', '\u2018', '\u2019'],  // Quote characters
        highlight: function (str, lang) {
            if (lang && hljs && hljs.getLanguage && hljs.getLanguage(lang)) {
                try {
                    return hljs.highlight(str, { language: lang }).value;
                } catch (error) {
                    console.warn('Syntax highlighting error:', error);
                }
            }
            
            // Escape special characters for HTML
            return md.utils.escapeHtml(str);
        }
    });
    
    // Add plugins for enhanced Markdown support
    try {
        if (window.markdownitSub) md.use(window.markdownitSub);
        if (window.markdownitSup) md.use(window.markdownitSup);
        if (window.markdownitFootnote) md.use(window.markdownitFootnote);
        if (window.markdownitDeflist) md.use(window.markdownitDeflist);
        if (window.markdownitAbbr) md.use(window.markdownitAbbr);
        if (window.markdownitEmoji) md.use(window.markdownitEmoji);
    } catch (e) {
        console.warn('Markdown plugins not available:', e);
    }
    
    // Initialize highlight.js
    if (hljs) {
        hljs.highlightAll();
    }
    
    let currentSessionId = null;
    let isStreaming = false;
    // Global variable to track if user has scrolled up
    let userScrolledUp = false;

    // Load user sessions
    function loadSessions() {
        fetch('{% url "get_user_sessions" %}')
            .then(response => response.json())
            .then(data => {
                const sessionsList = document.getElementById('sessions-list');
                sessionsList.innerHTML = '';
                
                if (data.sessions.length === 0) {
                    sessionsList.innerHTML = '<div class="list-group-item text-center text-muted">چتی وجود ندارد</div>';
                    return;
                }
                
                data.sessions.forEach(session => {
                    const sessionElement = document.createElement('div');
                    sessionElement.className = 'list-group-item session-item';
                    if (session.id == currentSessionId) {
                        sessionElement.classList.add('active');
                    }
                    sessionElement.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${session.title}</strong>
                                <div class="small text-muted">
                                    ${session.session_name} 
                                    <span class="model-access ${session.model_access.toLowerCase()}">
                                        ${session.model_access === 'Free' ? 'رایگان' : 'ویژه'}
                                    </span>
                                </div>
                            </div>
                            <div class="text-muted small">${new Date(session.updated_at).toLocaleTimeString('fa-IR')}</div>
                        </div>
                    `;
                    sessionElement.addEventListener('click', () => loadSession(session.id));
                    sessionsList.appendChild(sessionElement);
                });
            })
            .catch(error => console.error('Error loading sessions:', error));
    }

    // Utility function to scroll to bottom with better reliability
    // Modified to scroll the entire window instead of a container
    function scrollToBottom() {
        // Check if user has scrolled up, if so, don't auto-scroll
        if (typeof userScrolledUp !== 'undefined' && userScrolledUp) {
            return;
        }
        
        // Multiple approaches to ensure scrolling works in all scenarios
        function doScroll() {
            window.scrollTo(0, document.body.scrollHeight);
        }
        
        // Immediate scroll
        doScroll();
        
        // Scroll after a short delay to handle DOM updates
        setTimeout(doScroll, 10);
        
        // Scroll using requestAnimationFrame for better timing
        requestAnimationFrame(doScroll);
        
        // Additional scroll attempts with increasing delays
        setTimeout(doScroll, 50);
        setTimeout(doScroll, 100);
        setTimeout(doScroll, 200);
    }

    // Helper function to check if the user is near the bottom of the page
    function isUserAtBottom() {
        // A small buffer in pixels to ensure it works on all screen sizes
        const threshold = 50; 
        return (window.innerHeight + window.scrollY) >= (document.body.scrollHeight - threshold);
    }

    // Add scroll event listener to detect when user scrolls up
    document.addEventListener('DOMContentLoaded', function() {
        window.addEventListener('scroll', function() {
            // If user has scrolled up (not at bottom), set flag to true
            if (!isUserAtBottom()) {
                userScrolledUp = true;
            } else {
                // If user scrolls back to bottom, reset flag
                userScrolledUp = false;
            }
        });
    });

    // Load a specific session
    function loadSession(sessionId) {
        currentSessionId = sessionId;
        loadSessions(); // Update active state
    
        // Update URL to reflect the current session
        const newUrl = `/chat/session/${sessionId}/`;

        history.pushState({sessionId: sessionId}, '', newUrl);
        
        fetch(`/chat/session/${sessionId}/messages/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('current-session-title').innerHTML = `
                    <i class="fas fa-comments"></i> ${data.session_title}
                `;
                document.getElementById('delete-session-btn').style.display = 'inline-block';
                
                // Check if user has access to web search functionality
                checkWebSearchAccess(sessionId);
                
                // Check if user has access to image generation functionality
                checkImageGenerationAccess(sessionId);
                
                // Store session data including AI model name
                const sessionData = {
                    ai_model_name: data.ai_model_name,
                    session_name: data.session_name,
                    chatbot_type: data.chatbot_type,
                    chatbot_id: data.chatbot_id
                };
                localStorage.setItem(`session_${sessionId}`, JSON.stringify(sessionData));
                
                const chatContainer = document.getElementById('chat-container');
                chatContainer.innerHTML = '';
                
                if (data.messages.length === 0) {
                    chatContainer.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-comment-slash"></i> هنوز پیامی وجود ندارد. مکالمه را شروع کنید!
                        </div>
                    `;
                } else {
                    data.messages.forEach(message => {
                        addMessageToChat(message);
                    });
                }
                
                // Enable input fields
                document.getElementById('message-input').disabled = false;
                document.getElementById('send-button').disabled = false;
                
                // Scroll to bottom with enhanced reliability
                // Only scroll if user hasn't scrolled up
                if (typeof userScrolledUp !== 'undefined' && !userScrolledUp) {
                    scrollToBottom();
                }
                
                // Focus on input
                document.getElementById('message-input').focus();
                
                // Hide sidebar on mobile after selecting a session
                if (window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.remove('show');
                    document.getElementById('sidebar-overlay').classList.remove('show');
                }
            })
            .catch(error => console.error('Error loading session:', error));
    }
    
    // Add a function to check if we're on a specific session page
    function checkInitialSession() {
        // Check if we're on a session page (URL contains /chat/session/<id>/)
        const pathParts = window.location.pathname.split('/');
        if (pathParts.length >= 4 && pathParts[1] === 'chat' && pathParts[2] === 'session') {
            const sessionId = parseInt(pathParts[3]);
            if (sessionId) {
                loadSession(sessionId);
            }
        }
    }
    
    // Add message to chat display
    function addMessageToChat(message) {
        const chatContainer = document.getElementById('chat-container');
        const welcomeMessage = document.getElementById('welcome-message');
        if (welcomeMessage) {
            welcomeMessage.remove();
        }
        
        const messageElement = document.createElement('div');
        messageElement.className = `message-${message.type}`;
        
        // Format timestamp
        const timestamp = new Date(message.created_at).toLocaleTimeString('fa-IR');
        
        // Create message content with metadata
        let messageContent = message.content;
        
        // Render Markdown for assistant messages
        if (message.type === 'assistant') {
            try {
                messageContent = md.render(message.content);
            } catch (e) {
                console.error('Error rendering markdown:', e);
                // Show error message in Persian
                if (e.message && e.message.includes('code')) {
                    messageContent = '<div class="alert alert-warning">خطا: فرمت کد ارسال شده شناسایی نشد یا بلوک کد معتبر نیست.</div>' + md.utils.escapeHtml(message.content);
                } else {
                    // Fallback to plain text if markdown rendering fails
                    messageContent = md.utils.escapeHtml(message.content);
                }
            }
        }
        
        // Add AI model information for assistant messages
        let modelInfo = '';
        if (message.type === 'assistant' && currentSessionId) {
            // Get session info to display AI model name
            const sessionData = JSON.parse(localStorage.getItem(`session_${currentSessionId}`) || '{}');
            if (sessionData.ai_model_name) {
                modelInfo = `<div class="model-info">مدل: ${sessionData.ai_model_name}</div>`;
            }
        }
        
        // Add image display if image_url is present
        let imageContent = '';
        if (message.image_url) {
            // Split image URLs by comma in case there are multiple images
            const imageUrls = message.image_url.split(',');
            imageUrls.forEach(url => {
                if (url.trim()) {
                    // Handle both absolute URLs and relative paths
                    let imageUrl = url.trim();
                    // If it's a relative path, prepend the media URL
                    if (!imageUrl.startsWith('http') && !imageUrl.startsWith('/media/')) {
                        imageUrl = '/media/' + imageUrl;
                    }
                    // If it already starts with /media/, make sure it's properly formatted
                    else if (imageUrl.startsWith('/media/')) {
                        // It's already correctly formatted
                    }
                    // If it's already an absolute URL, leave it as is
                    imageContent += `<div class="image-container mt-2">
                        <img src="${imageUrl}" alt="Generated image" class="img-fluid rounded" style="max-width: 100%; height: auto;">
                        <div class="mt-1">
                            <a href="${imageUrl}" download class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-download"></i> دانلود تصویر
                            </a>
                        </div>
                    </div>`;
                }
            });
        }
        
        let content = `
            <div class="message-header">
                <strong>${message.type === 'user' ? 'شما' : 'دستیار'}</strong>
                <small class="text-muted float-end">${timestamp}</small>
            </div>
            <div class="message-content">${messageContent}</div>
            ${imageContent}
            ${modelInfo}
            <div class="message-actions mt-2">
                <button class="btn btn-sm btn-outline-secondary copy-btn" title="کپی">
                    <i class="fas fa-copy"></i> کپی
                </button>
                <button class="btn btn-sm btn-outline-primary share-btn" title="اشتراک‌گذاری">
                    <i class="fas fa-share"></i> اشتراک
                </button>
            </div>
        `;
        
        messageElement.innerHTML = content;
        chatContainer.appendChild(messageElement);
        
        // Apply syntax highlighting to code blocks
        if (message.type === 'assistant' && hljs) {
            const codeBlocks = messageElement.querySelectorAll('pre code');
            codeBlocks.forEach(block => {
                try {
                    hljs.highlightElement(block);
                } catch (e) {
                    console.warn('Syntax highlighting failed for block:', e);
                }
            });
        }
        
        // Add copy buttons to code blocks and quotes
        addCopyButtonsToContent(messageElement);
        
        // Add event listener for copy button
        const copyBtn = messageElement.querySelector('.copy-btn');
        copyBtn.addEventListener('click', function() {
            // Get the raw text content, not the HTML
            const messageContent = messageElement.querySelector('.message-content').textContent;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(messageContent).then(() => {
                    // Show success feedback
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-check"></i> کپی شد';
                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('کپی موفقیت‌آمیز نبود');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = messageContent;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    // Show success feedback
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-check"></i> کپی شد';
                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                    }, 2000);
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                    alert('کپی موفقیت‌آمیز نبود');
                }
                document.body.removeChild(textArea);
            }
        });
        
        // Add event listener for share button
        const shareBtn = messageElement.querySelector('.share-btn');
        shareBtn.addEventListener('click', function() {
            // Get the raw text content, not the HTML
            const messageContent = messageElement.querySelector('.message-content').textContent;
            if (navigator.share) {
                navigator.share({
                    title: 'پیام از MobixAI',
                    text: messageContent,
                }).catch((error) => console.log('Error sharing:', error));
            } else {
                // Fallback: copy to clipboard
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(messageContent).then(() => {
                        // Show success feedback
                        const originalText = shareBtn.innerHTML;
                        shareBtn.innerHTML = '<i class="fas fa-check"></i> کپی شد';
                        setTimeout(() => {
                            shareBtn.innerHTML = originalText;
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                        alert('اشتراک‌گذاری موفقیت‌آمیز نبود');
                    });
                } else {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = messageContent;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        // Show success feedback
                        const originalText = shareBtn.innerHTML;
                        shareBtn.innerHTML = '<i class="fas fa-check"></i> کپی شد';
                        setTimeout(() => {
                            shareBtn.innerHTML = originalText;
                        }, 2000);
                    } catch (err) {
                        console.error('Fallback: Oops, unable to copy', err);
                        alert('اشتراک‌گذاری موفقیت‌آمیز نبود');
                    }
                    document.body.removeChild(textArea);
                }
            }
        });
        
        // Scroll to bottom with enhanced reliability
        // Only scroll if user hasn't scrolled up
        if (typeof userScrolledUp !== 'undefined' && !userScrolledUp) {
            scrollToBottom();
        }
    }

    // Function to add copy buttons to code blocks and quotes
    function addCopyButtonsToContent(messageElement) {
        // Add copy buttons to code blocks
        const codeBlocks = messageElement.querySelectorAll('pre');
        codeBlocks.forEach(block => {
            // Check if copy button already exists
            if (!block.querySelector('.copy-code-btn')) {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'btn btn-sm btn-outline-secondary copy-code-btn';
                copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                copyBtn.title = 'کپی کد';
                copyBtn.style.cssText = 'position: absolute; top: 5px; left: 5px; z-index: 10;';
                
                // Wrap the code block in a relative container if needed
                const parent = block.parentNode;
                if (parent.style.position !== 'relative') {
                    block.style.position = 'relative';
                    block.style.paddingTop = '30px'; // Make space for the button
                }
                
                block.appendChild(copyBtn);
                
                copyBtn.addEventListener('click', function() {
                    const code = block.querySelector('code');
                    if (code) {
                        const text = code.textContent || code.innerText;
                        if (navigator.clipboard) {
                            navigator.clipboard.writeText(text).then(() => {
                                // Show success feedback
                                const originalHTML = copyBtn.innerHTML;
                                copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                                setTimeout(() => {
                                    copyBtn.innerHTML = originalHTML;
                                }, 2000);
                            }).catch(err => {
                                console.error('Failed to copy: ', err);
                            });
                        } else {
                            // Fallback for older browsers
                            const textArea = document.createElement('textarea');
                            textArea.value = text;
                            document.body.appendChild(textArea);
                            textArea.select();
                            try {
                                document.execCommand('copy');
                                // Show success feedback
                                const originalHTML = copyBtn.innerHTML;
                                copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                                setTimeout(() => {
                                    copyBtn.innerHTML = originalHTML;
                                }, 2000);
                            } catch (err) {
                                console.error('Fallback: Oops, unable to copy', err);
                            }
                            document.body.removeChild(textArea);
                        }
                    }
                });
            }
        });
        
        // Add copy buttons to blockquotes
        const blockquotes = messageElement.querySelectorAll('blockquote');
        blockquotes.forEach(blockquote => {
            // Check if copy button already exists
            if (!blockquote.querySelector('.copy-quote-btn')) {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'btn btn-sm btn-outline-secondary copy-quote-btn';
                copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                copyBtn.title = 'کپی نقل قول';
                copyBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; z-index: 10;';
                
                // Wrap the blockquote in a relative container if needed
                const parent = blockquote.parentNode;
                if (parent.style.position !== 'relative') {
                    blockquote.style.position = 'relative';
                    blockquote.style.paddingRight = '30px'; // Make space for the button
                }
                
                blockquote.appendChild(copyBtn);
                
                copyBtn.addEventListener('click', function() {
                    const text = blockquote.textContent || blockquote.innerText;
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(text).then(() => {
                            // Show success feedback
                            const originalHTML = copyBtn.innerHTML;
                            copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                            setTimeout(() => {
                                copyBtn.innerHTML = originalHTML;
                            }, 2000);
                        }).catch(err => {
                            console.error('Failed to copy: ', err);
                        });
                    } else {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            // Show success feedback
                            const originalHTML = copyBtn.innerHTML;
                            copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                            setTimeout(() => {
                                copyBtn.innerHTML = originalHTML;
                            }, 2000);
                        } catch (err) {
                            console.error('Fallback: Oops, unable to copy', err);
                        }
                        document.body.removeChild(textArea);
                    }
                });
            }
        });
        
        // Add copy buttons to blockquotes
        const quotes = messageElement.querySelectorAll('blockquote');
        quotes.forEach(quote => {
            // Check if copy button already exists
            if (!quote.querySelector('.copy-quote-btn')) {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'btn btn-sm btn-outline-secondary copy-quote-btn';
                copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                copyBtn.title = 'کپی نقل قول';
                copyBtn.style.cssText = 'position: absolute; top: 5px; left: 5px; z-index: 10;';
                
                // Wrap the quote in a relative container if needed
                if (quote.style.position !== 'relative') {
                    quote.style.position = 'relative';
                    quote.style.paddingTop = '30px'; // Make space for the button
                }
                
                quote.appendChild(copyBtn);
                
                copyBtn.addEventListener('click', function() {
                    const text = quote.textContent || quote.innerText;
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(text).then(() => {
                            // Show success feedback
                            const originalHTML = copyBtn.innerHTML;
                            copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                            setTimeout(() => {
                                copyBtn.innerHTML = originalHTML;
                            }, 2000);
                        }).catch(err => {
                            console.error('Failed to copy: ', err);
                        });
                    } else {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            // Show success feedback
                            const originalHTML = copyBtn.innerHTML;
                            copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                            setTimeout(() => {
                                copyBtn.innerHTML = originalHTML;
                            }, 2000);
                        } catch (err) {
                            console.error('Fallback: Oops, unable to copy', err);
                        }
                        document.body.removeChild(textArea);
                    }
                });
            }
        });
    }
    
    // Show typing indicator
    function showTypingIndicator() {
        const chatContainer = document.getElementById('chat-container');
        const welcomeMessage = document.getElementById('welcome-message');
        if (welcomeMessage) {
            welcomeMessage.remove();
        }
        
        const typingElement = document.createElement('div');
        typingElement.className = 'typing-indicator';
        typingElement.id = 'typing-indicator';
        typingElement.innerHTML = '<span></span><span></span><span></span>';
        chatContainer.appendChild(typingElement);
        
        // Ensure scroll to bottom with enhanced reliability
        scrollToBottom();
    }

    // Hide typing indicator
    function hideTypingIndicator() {
        const typingElement = document.getElementById('typing-indicator');
        if (typingElement) {
            typingElement.remove();
        }
    }

    // Send message with streaming support
    function sendMessage() {
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();
        const fileInput = document.getElementById('file-input');
        let file = null;
        
        // Safely get file if fileInput exists
        if (fileInput && fileInput.files && fileInput.files.length > 0) {
            file = fileInput.files[0];
        }

        if (!message && !file) return;

        // Add user message to chat immediately
        let displayMessage = message;
        if (file) {
            displayMessage += ` (فایل: ${file.name})`;
        }

        addMessageToChat({
            type: 'user',
            content: displayMessage,
            created_at: new Date().toISOString()
        });

        // Clear inputs
        messageInput.value = '';
        resetFileInputState(); // Use the robust reset function
        // Don't disable the send button immediately - keep it enabled for stop functionality
        // document.getElementById('send-button').disabled = true;

        // Disable input while processing
        messageInput.disabled = true;

        // Show typing indicator
        showTypingIndicator();

        // Check if this is the first message to generate title
        checkAndGenerateTitle(message);

        const isWebSearchEnabled = sessionStorage.getItem(`webSearch_${currentSessionId}`) === 'true';
        const isImageGenerationEnabled = sessionStorage.getItem(`imageGen_${currentSessionId}`) === 'true';

        // ALWAYS use FormData to send the request
        const formData = new FormData();
        formData.append('message', message);
        formData.append('use_web_search', isWebSearchEnabled);
        formData.append('generate_image', isImageGenerationEnabled);
        if (file) {
            formData.append('file', file);
        }

        let assistantContent = '';
        let imagesData = [];
        
        // ساخت یک کنترلر جدید برای هر درخواست
        abortController = new AbortController(); // ساخت یک کنترلر جدید برای هر درخواست
        setButtonState(true); // تغییر دکمه به حالت "توقف"

        // Unified fetch request to 'send_message' endpoint
        fetch(`/chat/session/${currentSessionId}/send/`, {
            method: 'POST',
            headers: {
                // 'Content-Type' is automatically set to 'multipart/form-data' by the browser when using FormData
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData,
            signal: abortController.signal // اتصال کنترلر به درخواست
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Error sending message');
                });
            }

            // Handle streaming response
            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');

            function read() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        const streamingElement = document.getElementById('streaming-assistant');
                        if (streamingElement) {
                            streamingElement.remove();
                        }
                        
                        // Add final message with images if any
                        const messageData = {
                            type: 'assistant',
                            content: assistantContent,
                            created_at: new Date().toISOString()
                        };
                        
                        // Add image URLs if any images were generated
                        if (imagesData.length > 0) {
                            // Format image URLs properly
                            const formattedImageUrls = imagesData.map(img => {
                                if (img.image_url && img.image_url.url) {
                                    let imageUrl = img.image_url.url;
                                    // If it's a relative path, prepend the media URL
                                    if (!imageUrl.startsWith('http') && !imageUrl.startsWith('/media/')) {
                                        imageUrl = '/media/' + imageUrl;
                                    }
                                    return imageUrl;
                                }
                                return '';
                            }).filter(url => url.trim() !== '');
                            
                            messageData.image_url = formattedImageUrls.join(',');
                        }
                        
                        addMessageToChat(messageData);
                        hideTypingIndicator();
                        // Re-enable input and reset button state after streaming is complete
                        messageInput.disabled = false;
                        messageInput.focus();
                        setButtonState(false); // بازگرداندن دکمه به حالت "ارسال"
                        return;
                    }

                    try {
                        const chunk = decoder.decode(value, { stream: true });
                        
                        // Handle image data
                        if (chunk.includes('[IMAGES]') && chunk.includes('[IMAGES_END]')) {
                            const startIdx = chunk.indexOf('[IMAGES]') + 8;
                            const endIdx = chunk.indexOf('[IMAGES_END]');
                            const imagesJson = chunk.substring(startIdx, endIdx);
                            try {
                                const newImages = JSON.parse(imagesJson);
                                imagesData = imagesData.concat(newImages);
                                // Update the streaming message with images
                                updateOrAddAssistantMessageWithImages(assistantContent, imagesData);
                            } catch (parseError) {
                                console.error('Error parsing images data:', parseError);
                            }
                        }
                        // Handle usage data (ignore for now)
                        else if (chunk.includes('[USAGE_DATA]') && chunk.includes('[USAGE_DATA_END]')) {
                            // We don't need to do anything with usage data here
                            // It's handled on the server side
                        }
                        // Handle regular content
                        else {
                            assistantContent += chunk;
                            // Update the streaming message with current content
                            if (imagesData.length > 0) {
                                updateOrAddAssistantMessageWithImages(assistantContent, imagesData);
                            } else {
                                updateOrAddAssistantMessage(assistantContent);
                            }
                        }
                    } catch (decodeError) {
                        console.error('Decoding error:', decodeError);
                    }
                    
                    read();
                }).catch(error => {
                    if (error.name === 'AbortError') {
                        console.log('درخواست توسط کاربر متوقف شد.');
                        // پیام ناقص قبلاً در سمت سرور ذخیره شده است
                        const streamingElement = document.getElementById('streaming-assistant');
                        if (streamingElement) {
                            streamingElement.remove();
                        }
                        hideTypingIndicator();
                        // Add final message with whatever content we have so far
                        if (assistantContent) {
                            const messageData = {
                                type: 'assistant',
                                content: assistantContent,
                                created_at: new Date().toISOString()
                            };
                            // Add image URLs if any images were generated
                            if (imagesData.length > 0) {
                                // Format image URLs properly
                                const formattedImageUrls = imagesData.map(img => {
                                    if (img.image_url && img.image_url.url) {
                                        let imageUrl = img.image_url.url;
                                        // If it's a relative path, prepend the media URL
                                        if (!imageUrl.startsWith('http') && !imageUrl.startsWith('/media/')) {
                                            imageUrl = '/media/' + imageUrl;
                                        }
                                        return imageUrl;
                                    }
                                    return '';
                                }).filter(url => url.trim() !== '');
                                
                                messageData.image_url = formattedImageUrls.join(',');
                            }
                            addMessageToChat(messageData);
                        }
                        // Re-enable input and reset button state after streaming is complete
                        messageInput.disabled = false;
                        messageInput.focus();
                        setButtonState(false); // بازگرداندن دکمه به حالت "ارسال"
                    } else {
                        console.error('Streaming error:', error);
                        const streamingElement = document.getElementById('streaming-assistant');
                        if (streamingElement) {
                            streamingElement.remove();
                        }
                        hideTypingIndicator();
                        addMessageToChat({
                            type: 'assistant',
                            content: `خطا: ${error.message || 'خطای نامشخص'}`,
                            created_at: new Date().toISOString()
                        });
                        // Re-enable input and reset button state after streaming is complete
                        messageInput.disabled = false;
                        messageInput.focus();
                        setButtonState(false); // بازگرداندن دکمه به حالت "ارسال"
                    }
                });
            }
            read();
        })
        .catch(error => {
            if (error.name === 'AbortError') {
                console.log('درخواست توسط کاربر متوقف شد.');
                // پیام ناقص قبلاً در سمت سرور ذخیره شده است
                hideTypingIndicator();
                // Add final message with whatever content we have so far
                if (assistantContent) {
                    const messageData = {
                        type: 'assistant',
                        content: assistantContent,
                        created_at: new Date().toISOString()
                    };
                    // Add image URLs if any images were generated
                    if (imagesData.length > 0) {
                        // Format image URLs properly
                        const formattedImageUrls = imagesData.map(img => {
                            if (img.image_url && img.image_url.url) {
                                let imageUrl = img.image_url.url;
                                // If it's a relative path, prepend the media URL
                                if (!imageUrl.startsWith('http') && !imageUrl.startsWith('/media/')) {
                                    imageUrl = '/media/' + imageUrl;
                                }
                                return imageUrl;
                            }
                            return '';
                        }).filter(url => url.trim() !== '');
                        
                        messageData.image_url = formattedImageUrls.join(',');
                    }
                    addMessageToChat(messageData);
                }
            } else {
                console.error('Error:', error);
                hideTypingIndicator();
                addMessageToChat({
                    type: 'assistant',
                    content: `خطا: ${error.message || 'خطای نامشخص'}`,
                    created_at: new Date().toISOString()
                });
            }
            // Re-enable input and reset button state after streaming is complete
            messageInput.disabled = false;
            messageInput.focus();
            setButtonState(false); // بازگرداندن دکمه به حالت "ارسال"
        });
    }
    
    // Check if this is the first message and generate title
    async function checkAndGenerateTitle(message) {
        // Only generate title for the first message
        const chatContainer = document.getElementById('chat-container');
        const messageElements = chatContainer.querySelectorAll('.message-user, .message-assistant');
        
        // If this is the first user message (should be the only user message in container)
        // Count only user messages to determine if this is the first one
        const userMessageElements = chatContainer.querySelectorAll('.message-user');
        if (userMessageElements.length === 1 && currentSessionId) {
            try {
                // Get session info to get chatbot and model IDs
                const response = await fetch(`/chat/session/${currentSessionId}/messages/`);
                const sessionData = await response.json();
                
                // Generate title using the first message
                const titleResponse = await fetch('{% url "generate_chat_title" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        first_message: message,
                        chatbot_id: sessionData.chatbot_id, // This will be the chatbot ID
                        model_id: null // We'll use chatbot_id instead
                    })
                });
                
                const titleData = await titleResponse.json();
                const newTitle = titleData.title || 'چت جدید';
                
                // Update the session title
                await fetch(`/chat/session/${currentSessionId}/update-title/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        title: newTitle
                    })
                });
                
                // Update UI with new title
                document.getElementById('current-session-title').textContent = newTitle;
                
                // Refresh sessions list
                loadSessions();
            } catch (error) {
                console.error('Error generating title:', error);
            }
        }
    }
    
    // Update or add assistant message for streaming
    function updateOrAddAssistantMessage(content) {
        const chatContainer = document.getElementById('chat-container');
        let assistantElement = document.getElementById('streaming-assistant');
        
        // Render Markdown for the content
        let renderedContent;
        try {
            renderedContent = md.render(content);
        } catch (e) {
            console.error('Error rendering markdown:', e);
            // Show error message in Persian
            if (e.message && e.message.includes('code') || e.message.includes('quote') || e.message.includes('newline')) {
                renderedContent = '<div class="alert alert-warning">هشدار: فرمت خط جدید یا نقل‌قول‌ها به درستی رندر نشدند.</div>' + md.utils.escapeHtml(content);
            } else {
                // Fallback to plain text if markdown rendering fails
                renderedContent = md.utils.escapeHtml(content);
            }
        }
        
        if (!assistantElement) {
            // Create new assistant message element with same structure as addMessageToChat
            assistantElement = document.createElement('div');
            assistantElement.className = 'message-assistant';
            assistantElement.id = 'streaming-assistant';
            
            // Format timestamp
            const timestamp = new Date().toLocaleTimeString('fa-IR');
            
            // Create message content with metadata (similar to addMessageToChat)
            let elementContent = `
                <div class="message-header">
                    <strong>دستیار</strong>
                    <small class="text-muted float-end">${timestamp}</small>
                </div>
                <div class="message-content">${renderedContent}</div>
            `;
            assistantElement.innerHTML = elementContent;
            chatContainer.appendChild(assistantElement);
        } else {
            // Update existing element content only
            const contentDiv = assistantElement.querySelector('.message-content');
            if (contentDiv) {
                contentDiv.innerHTML = renderedContent;
                
                // Apply syntax highlighting to new code blocks
                if (hljs) {
                    const codeBlocks = contentDiv.querySelectorAll('pre code');
                    codeBlocks.forEach(block => {
                        if (!block.dataset.highlighted) {
                            try {
                                hljs.highlightElement(block);
                                block.dataset.highlighted = 'true';
                            } catch (e) {
                                console.warn('Syntax highlighting failed for block:', e);
                            }
                        }
                    });
                }
            }
        }
        
        // Add copy buttons to code blocks and quotes
        addCopyButtonsToContent(assistantElement);
        
        // Scroll to bottom with enhanced reliability
        // Only scroll if user hasn't scrolled up
        if (typeof userScrolledUp !== 'undefined' && !userScrolledUp) {
            scrollToBottom();
        }
    }

    // Update the streaming handler to handle images
    function updateOrAddAssistantMessageWithImages(content, imagesData = null) {
        const chatContainer = document.getElementById('chat-container');
        let assistantElement = document.getElementById('streaming-assistant');
        
        // Render Markdown for the content
        let renderedContent;
        try {
            renderedContent = md.render(content);
        } catch (e) {
            console.error('Error rendering markdown:', e);
            // Show error message in Persian
            if (e.message && e.message.includes('code') || e.message.includes('quote') || e.message.includes('newline')) {
                renderedContent = '<div class="alert alert-warning">هشدار: فرمت خط جدید یا نقل‌قول‌ها به درستی رندر نشدند.</div>' + md.utils.escapeHtml(content);
            } else {
                // Fallback to plain text if markdown rendering fails
                renderedContent = md.utils.escapeHtml(content);
            }
        }
        
        // Add image display if imagesData is present
        let imageContent = '';
        if (imagesData && imagesData.length > 0) {
            imagesData.forEach(img => {
                if (img.image_url && img.image_url.url) {
                    // Handle both absolute URLs and relative paths
                    let imageUrl = img.image_url.url;
                    // If it's a relative path, prepend the media URL
                    if (!imageUrl.startsWith('http') && !imageUrl.startsWith('/media/')) {
                        imageUrl = '/media/' + imageUrl;
                    }
                    // If it already starts with /media/, make sure it's properly formatted
                    else if (imageUrl.startsWith('/media/')) {
                        // It's already correctly formatted
                    }
                    // If it's already an absolute URL, leave it as is
                    imageContent += `<div class="image-container mt-2">
                        <img src="${imageUrl}" alt="Generated image" class="img-fluid rounded" style="max-width: 100%; height: auto;">
                        <div class="mt-1">
                            <a href="${imageUrl}" download class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-download"></i> دانلود تصویر
                            </a>
                        </div>
                    </div>`;
                }
            });
        }
        
        if (!assistantElement) {
            // Create new assistant message element with same structure as addMessageToChat
            assistantElement = document.createElement('div');
            assistantElement.className = 'message-assistant';
            assistantElement.id = 'streaming-assistant';
            
            // Format timestamp
            const timestamp = new Date().toLocaleTimeString('fa-IR');
            
            // Create message content with metadata (similar to addMessageToChat)
            let elementContent = `
                <div class="message-header">
                    <strong>دستیار</strong>
                    <small class="text-muted float-end">${timestamp}</small>
                </div>
                <div class="message-content">${renderedContent}</div>
                ${imageContent}
            `;
            assistantElement.innerHTML = elementContent;
            chatContainer.appendChild(assistantElement);
        } else {
            // Update existing element content only
            const contentDiv = assistantElement.querySelector('.message-content');
            if (contentDiv) {
                contentDiv.innerHTML = renderedContent;
                
                // Apply syntax highlighting to new code blocks
                if (hljs) {
                    const codeBlocks = contentDiv.querySelectorAll('pre code');
                    codeBlocks.forEach(block => {
                        if (!block.dataset.highlighted) {
                            try {
                                hljs.highlightElement(block);
                                block.dataset.highlighted = 'true';
                            } catch (e) {
                                console.warn('Syntax highlighting failed for block:', e);
                            }
                        }
                    });
                }
            }
            
            // Add images if they exist and haven't been added yet
            if (imageContent && !assistantElement.querySelector('.image-container')) {
                assistantElement.insertAdjacentHTML('beforeend', imageContent);
            }
        }
        
        // Add copy buttons to code blocks and quotes
        addCopyButtonsToContent(assistantElement);
        
        // Scroll to bottom during streaming ONLY if the user is already at the bottom
        // and hasn't scrolled up manually
        if (typeof userScrolledUp !== 'undefined' && !userScrolledUp && isUserAtBottom()) {
            scrollToBottom();
        }
    }
    
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Generate chat title using AI
    function generateChatTitle(firstMessage, chatbotId, modelId) {
        const data = {
            first_message: firstMessage
        };
        
        // Add either chatbot_id or model_id based on what's provided
        if (chatbotId) {
            data.chatbot_id = chatbotId;
        } else if (modelId) {
            data.model_id = modelId;
        }
        
        return fetch('{% url "generate_chat_title" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => data.title || 'چت جدید');
    }
    
    // Create new chat
    async function createNewChat() {
        const chatbotId = document.getElementById('modal-chatbot-select').value;
        const modelId = document.getElementById('modal-model-select').value;
        
        // Validate selections
        if (!chatbotId || !modelId) {
            alert('لطفاً هم یک چت‌بات و هم یک مدل هوش مصنوعی انتخاب کنید');
            return;
        }
        
        // Use default title
        const title = 'چت جدید';
        
        fetch('{% url "create_session" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                title: title,
                chatbot_id: chatbotId,
                ai_model_id: modelId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('خطا: ' + data.error);
                return;
            }
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('newChatModal')).hide();
            
            // Load the new session
            loadSession(data.session_id);
            
            // Refresh sessions list
            loadSessions();
        })
        .catch(error => {
            console.error('Error creating chat:', error);
            alert('خطا در ایجاد چت: ' + error.message);
        });
    }
    
    // Delete session
    function deleteSession() {
        if (!currentSessionId) return;
        
        if (confirm('آیا مطمئن هستید که می‌خواهید این جلسه چت را حذف کنید؟')) {
            // Send DELETE request to remove the session
            fetch(`/chat/session/${currentSessionId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                if (response.ok) {
                    // Reset UI
                    currentSessionId = null;
                    document.getElementById('current-session-title').innerHTML = `
                        <i class="fas fa-comments"></i> چت را انتخاب کنید یا جدیدی ایجاد کنید
                    `;
                    document.getElementById('chat-container').innerHTML = ```

                        <div class="text-center text-muted welcome-message" id="welcome-message">
                            <i class="fas fa-robot fa-3x mb-3"></i>
                            <h4>به چت‌بات MobixAI خوش آمدید</h4>
                            <p class="mb-0">چتی را انتخاب کنید یا چت جدیدی شروع کنید</p>
                        </div>
                    `;
                    document.getElementById('message-input').disabled = true;
                    document.getElementById('send-button').disabled = true;
                    document.getElementById('delete-session-btn').style.display = 'none';
                    loadSessions();
                    
                    // Hide sidebar on mobile
                    if (window.innerWidth < 768) {
                        document.getElementById('sidebar').classList.remove('show');
                        document.getElementById('sidebar-overlay').classList.remove('show');
                    }
                } else {
                    alert('خطا در حذف چت');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('خطا در حذف چت');
            });
        }
    }
    
    // Check if both chatbot and model are selected in modal
    function checkModalSelections() {
        const chatbotSelect = document.getElementById('modal-chatbot-select');
        const modelSelect = document.getElementById('modal-model-select');
        const createBtn = document.getElementById('create-chat-btn');
        
        const chatbotSelected = chatbotSelect.value;
        const modelSelected = modelSelect.value;
        
        // Both chatbot and model must be selected
        if (chatbotSelected && modelSelected) {
            createBtn.disabled = false;
        } else {
            createBtn.disabled = true;
        }
    }
    
    // Check if both chatbot and model are selected in sidebar
    function checkSidebarSelections() {
        const chatbotSelect = document.getElementById('chatbot-select');
        const startBtn = document.getElementById('start-chat-btn');
        
        const chatbotSelected = chatbotSelect.value;
        
        // Chatbot must be selected
        if (chatbotSelected) {
            startBtn.disabled = false;
        } else {
            startBtn.disabled = true;
        }
    }
    
    // Web search toggle
    function toggleWebSearch() {
        if (!currentSessionId) return;
        
        const webSearchBtn = document.getElementById('web-search-btn');
        const isWebSearchActive = webSearchBtn.classList.contains('btn-success');
        
        if (isWebSearchActive) {
            // Disable web search
            webSearchBtn.classList.remove('btn-success');
            webSearchBtn.classList.add('btn-outline-secondary');
            webSearchBtn.innerHTML = '<i class="fas fa-search"></i> جستجو وب';
            webSearchBtn.title = 'فعال کردن جستجو وب';
            // Store that web search is disabled for this session
            sessionStorage.setItem(`webSearch_${currentSessionId}`, 'false');
        } else {
            // Enable web search
            webSearchBtn.classList.remove('btn-outline-secondary');
            webSearchBtn.classList.add('btn-success');
            webSearchBtn.innerHTML = '<i class="fas fa-search"></i> جستجو وب فعال';
            webSearchBtn.title = 'غیرفعال کردن جستجو وب';
            // Store that web search is enabled for this session
            sessionStorage.setItem(`webSearch_${currentSessionId}`, 'true');
        }
    }
    
    // Check if user has access to web search functionality
    function checkWebSearchAccess(sessionId) {
        fetch(`/chat/session/${sessionId}/web-search-access/`)
            .then(response => response.json())
            .then(data => {
                const webSearchBtn = document.getElementById('web-search-btn');
                // Check if this is an image editing chatbot
                const sessionData = JSON.parse(localStorage.getItem(`session_${sessionId}`) || '{}');
                if (sessionData.chatbot_type === 'image_editing') {
                    // Hide web search for image editing chatbots
                    webSearchBtn.style.display = 'none';
                    return;
                }
                
                if (data.has_access) {
                    // User has access, show the button
                    webSearchBtn.style.display = 'inline-block';
                    
                    // Restore web search state for this session
                    const webSearchState = sessionStorage.getItem(`webSearch_${sessionId}`);
                    if (webSearchState === 'true') {
                        // Enable web search
                        webSearchBtn.classList.remove('btn-outline-secondary');
                        webSearchBtn.classList.add('btn-success');
                        webSearchBtn.innerHTML = '<i class="fas fa-search"></i> جستجو وب فعال';
                        webSearchBtn.title = 'غیرفعال کردن جستجو وب';
                    } else {
                        // Disable web search
                        webSearchBtn.classList.remove('btn-success');
                        webSearchBtn.classList.add('btn-outline-secondary');
                        webSearchBtn.innerHTML = '<i class="fas fa-search"></i> جستجو وب';
                        webSearchBtn.title = 'فعال کردن جستجو وب';
                    }
                } else {
                    // User doesn't have access, hide the button or show it as disabled
                    webSearchBtn.style.display = 'inline-block';
                    webSearchBtn.classList.remove('btn-outline-secondary', 'btn-success');
                    webSearchBtn.classList.add('btn-secondary');
                    webSearchBtn.disabled = true;
                    webSearchBtn.innerHTML = '<i class="fas fa-search"></i> جستجو وب (فقط برای اشتراک ویژه)';
                    webSearchBtn.title = 'این ویژگی فقط برای کاربران با اشتراک ویژه در دسترس است';
                }
            })
            .catch(error => {
                console.error('Error checking web search access:', error);
                // Hide the button if there's an error
                document.getElementById('web-search-btn').style.display = 'none';
            });
    }
    
    // Add image generation toggle
    function toggleImageGeneration() {
        if (!currentSessionId) return;
        
        const imageGenBtn = document.getElementById('image-generation-btn');
        const isImageGenActive = imageGenBtn.classList.contains('btn-primary');
        
        if (isImageGenActive) {
            // Disable image generation
            imageGenBtn.classList.remove('btn-primary');
            imageGenBtn.classList.add('btn-outline-primary');
            imageGenBtn.innerHTML = '<i class="fas fa-image"></i> تولید تصویر';
            imageGenBtn.title = 'فعال کردن تولید تصویر';
            // Store that image generation is disabled for this session
            sessionStorage.setItem(`imageGen_${currentSessionId}`, 'false');
        } else {
            // Enable image generation
            imageGenBtn.classList.remove('btn-outline-primary');
            imageGenBtn.classList.add('btn-primary');
            imageGenBtn.innerHTML = '<i class="fas fa-image"></i> تولید تصویر فعال';
            imageGenBtn.title = 'غیرفعال کردن تولید تصویر';
            // Store that image generation is enabled for this session
            sessionStorage.setItem(`imageGen_${currentSessionId}`, 'true');
        }
    }
    
    // Check if user has access to image generation functionality
    function checkImageGenerationAccess(sessionId) {
        fetch(`/chat/session/${sessionId}/image-generation-access/`)
            .then(response => response.json())
            .then(data => {
                const imageGenBtn = document.getElementById('image-generation-btn');
                const webSearchBtn = document.getElementById('web-search-btn');
                if (data.has_access) {
                    // Check if this is an image editing chatbot
                    const sessionData = JSON.parse(localStorage.getItem(`session_${sessionId}`) || '{}');
                    if (sessionData.chatbot_type === 'image_editing') {
                        // For image editing chatbots:
                        // 1. Hide the image generation button (it's automatic)
                        imageGenBtn.style.display = 'none';
                        // 2. Enable image generation by default
                        sessionStorage.setItem(`imageGen_${sessionId}`, 'true');
                        // 3. Hide the web search button
                        webSearchBtn.style.display = 'none';
                    } else {
                        // For other chatbots:
                        // 1. Show the image generation button
                        imageGenBtn.style.display = 'inline-block';
                        // 2. Show the web search button
                        webSearchBtn.style.display = 'inline-block';
                        // 3. Restore image generation state for this session
                        const imageGenState = sessionStorage.getItem(`imageGen_${sessionId}`);
                        if (imageGenState === 'true') {
                            // Enable image generation
                            imageGenBtn.classList.remove('btn-outline-primary');
                            imageGenBtn.classList.add('btn-primary');
                            imageGenBtn.innerHTML = '<i class="fas fa-image"></i> تولید تصویر فعال';
                            imageGenBtn.title = 'غیرفعال کردن تولید تصویر';
                        } else {
                            // Disable image generation
                            imageGenBtn.classList.remove('btn-primary');
                            imageGenBtn.classList.add('btn-outline-primary');
                            imageGenBtn.innerHTML = '<i class="fas fa-image"></i> تولید تصویر';
                            imageGenBtn.title = 'فعال کردن تولید تصویر';
                        }
                    }
                } else {
                    // User doesn't have access, hide the button
                    imageGenBtn.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error checking image generation access:', error);
                // Hide the button if there's an error
                document.getElementById('image-generation-btn').style.display = 'none';
            });
    }
    
    // Toggle sidebar on mobile
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        
        if (sidebar) {
            sidebar.classList.toggle('show');
        }
        if (overlay) {
            overlay.classList.toggle('show');
        }
    }
    
    // Toggle sessions list visibility
    function toggleSessionsList() {
        const sessionsContainer = document.getElementById('sessions-container');
        const toggleBtn = document.getElementById('toggle-sessions');
        const icon = toggleBtn.querySelector('i');
        
        if (sessionsContainer.classList.contains('collapsed')) {
            // Show sessions
            sessionsContainer.classList.remove('collapsed');
            sessionsContainer.style.display = 'block';
            icon.className = 'fas fa-chevron-up';
            toggleBtn.title = 'جمع کردن چت‌ها';
        } else {
            // Hide sessions
            sessionsContainer.classList.add('collapsed');
            sessionsContainer.style.display = 'none';
            icon.className = 'fas fa-chevron-down';
            toggleBtn.title = 'باز کردن چت‌ها';
        }
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        loadSessions();
        checkInitialSession(); // Check if we should load a specific session
        
        // Clicking on message input opens new chat modal if no session is selected
        document.getElementById('message-input').addEventListener('click', function() {
            if (!currentSessionId) {
                // Open new chat modal
                document.getElementById('modal-chatbot-select').value = '';
                document.getElementById('modal-model-select').value = '';
                document.getElementById('create-chat-btn').disabled = true;
                const modal = new bootstrap.Modal(document.getElementById('newChatModal'));
                modal.show();
            }
        });
        
        // New chat button opens modal
        document.getElementById('new-chat-btn').addEventListener('click', function() {
            document.getElementById('modal-chatbot-select').value = '';
            document.getElementById('modal-model-select').value = '';
            document.getElementById('create-chat-btn').disabled = true;
            const modal = new bootstrap.Modal(document.getElementById('newChatModal'));
            modal.show();
        });
        
        // Toggle sessions list
        document.getElementById('toggle-sessions').addEventListener('click', toggleSessionsList);
        
        // Modal selection change listeners
        document.getElementById('modal-chatbot-select').addEventListener('change', function() {
            checkModalSelections();
            // Load models based on chatbot type
            const chatbotId = this.value;
            if (chatbotId) {
                loadModelsForChatbot(chatbotId);
            }
        });
        document.getElementById('modal-model-select').addEventListener('change', checkModalSelections);
        
        // Modal create button
        document.getElementById('create-chat-btn').addEventListener('click', createNewChat);
        
        // Send message form submission
        document.getElementById('chat-form').addEventListener('submit', function(event) {
            event.preventDefault();
            sendMessage();
        });
        
        // Send message button (for direct click as well)
        document.getElementById('send-button').addEventListener('click', function(event) {
            event.preventDefault();
            document.getElementById('chat-form').dispatchEvent(new Event('submit'));
        });
        
        // Enter key in message input
        document.getElementById('message-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('chat-form').dispatchEvent(new Event('submit'));
            }
        });
        
        // Delete session button
        document.getElementById('delete-session-btn').addEventListener('click', deleteSession);
        
        // Web search button
        document.getElementById('web-search-btn').addEventListener('click', toggleWebSearch);
        
        // Image generation button
        document.getElementById('image-generation-btn').addEventListener('click', toggleImageGeneration);
        
        // Mobile sidebar toggle - moved from base.html to here where sidebar exists
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent event bubbling
                toggleSidebar();
            });
        }
        
        // Mobile sidebar toggle button in sidebar
        if (document.getElementById('toggle-sidebar')) {
            document.getElementById('toggle-sidebar').addEventListener('click', toggleSidebar);
        }
        
        // Overlay click to close sidebar
        if (document.getElementById('sidebar-overlay')) {
            document.getElementById('sidebar-overlay').addEventListener('click', toggleSidebar);
        }
        
        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.sessionId) {
                loadSession(event.state.sessionId);
            } else {
                // Reset to default state
                currentSessionId = null;
                document.getElementById('current-session-title').innerHTML = `
                    <i class="fas fa-comments"></i> چت را انتخاب کنید یا جدیدی ایجاد کنید
                `;
                document.getElementById('chat-container').innerHTML = `
                    <div class="text-center text-muted welcome-message" id="welcome-message">
                        <i class="fas fa-robot fa-3x mb-3"></i>
                        <h4>به چت‌بات MobixAI خوش آمدید</h4>
                        <p class="mb-0">چتی را انتخاب کنید یا چت جدیدی شروع کنید</p>
                    </div>
                `;
                document.getElementById('message-input').disabled = true;
                document.getElementById('send-button').disabled = true;
                document.getElementById('delete-session-btn').style.display = 'none';
            }
        });
        
        // Add file upload functionality
        const uploadBtn = document.getElementById('upload-btn');
        const initialFileInput = document.getElementById('file-input');
        const removeFileBtn = document.getElementById('remove-file');
        
        // Function to handle file input change for preview
        function handleFileInputChange() {
            const file = this.files[0];
            if (file) {
                // Show file preview
                const fileNameElement = document.getElementById('file-name');
                fileNameElement.textContent = file.name;
                
                // Add file icon based on file type
                const iconElement = document.querySelector('#file-preview .fa-file-image');
                if (file.type.startsWith('image/')) {
                    iconElement.className = 'fas fa-file-image text-primary me-2';
                } else if (file.type === 'application/pdf') {
                    iconElement.className = 'fas fa-file-pdf text-danger me-2';
                } else if (file.type.startsWith('text/')) {
                    iconElement.className = 'fas fa-file-alt text-info me-2';
                } else {
                    iconElement.className = 'fas fa-file text-muted me-2';
                }
                
                document.getElementById('file-preview').style.display = 'block';
                
                // Enable send button when file is selected
                document.getElementById('send-button').disabled = false;
            }
        }
        
        // Function to reset file input state properly
        function resetFileInputState() {
            const fileInput = document.getElementById('file-input');
            const filePreview = document.getElementById('file-preview');
            
            if (fileInput) {
                // Create a clean clone of the file input
                const newFileInput = fileInput.cloneNode(true);
                
                // Replace the old file input with the new one
                fileInput.parentNode.replaceChild(newFileInput, fileInput);
                
                // Add the change event listener to the new input - اضافه کردن event listener به element جدید
                newFileInput.addEventListener('change', handleFileInputChange);
                
                // اطمینان از اینکه upload button به element جدید متصل شود
                const uploadBtn = document.getElementById('upload-btn');
                if (uploadBtn) {
                    // حذف listener قبلی و اضافه کردن listener جدید
                    uploadBtn.replaceWith(uploadBtn.cloneNode(true));
                    const newUploadBtn = document.getElementById('upload-btn');
                    newUploadBtn.addEventListener('click', function() {
                        document.getElementById('file-input').click();
                    });
                }
            }
            
            if (filePreview) {
                filePreview.style.display = 'none';
            }
            
            // Disable send button if no message
            const message = document.getElementById('message-input').value.trim();
            if (!message) {
                document.getElementById('send-button').disabled = true;
            }
        }
        
        if (uploadBtn && initialFileInput) {
            // Always get the current file input element directly from DOM
            uploadBtn.addEventListener('click', function() {
                document.getElementById('file-input').click();
            });
            
            // Add change event listener to initial file input
            initialFileInput.addEventListener('change', handleFileInputChange);
        }
        
        if (removeFileBtn) {
            // Use the safe reset function for file removal
            removeFileBtn.addEventListener('click', function() {
                resetFileInputState();
            });
        }
        
        // Update the input event listener to enable send button when there's text or file
        document.getElementById('message-input').addEventListener('input', function() {
            const sendBtn = document.getElementById('send-button');
            const fileInput = document.getElementById('file-input');
            
            // Enable send button if there's a message or file
            if (this.value.trim() || (fileInput && fileInput.files && fileInput.files.length > 0)) {
                sendBtn.disabled = false;
            } else {
                sendBtn.disabled = true;
            }
        });

    });

    // Load models for a specific chatbot
    function loadModelsForChatbot(chatbotId) {
        const modelSelect = document.getElementById('modal-model-select');
        
        // Clear current options
        modelSelect.innerHTML = '<option value="">-- مدلی را انتخاب کنید --</option>';
        
        // Load models for this chatbot
        fetch(`/chat/chatbot/${chatbotId}/models/`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading models:', data.error);
                    return;
                }
                
                // Populate model select
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.model_id;
                    option.textContent = model.name;
                    option.dataset.isFree = model.is_free;
                    
                    // Add badge for free/premium models
                    if (model.is_free) {
                        option.innerHTML += ' <span class="badge bg-success">رایگان</span>';
                    } else {
                        option.innerHTML += ' <span class="badge bg-warning">ویژه</span>';
                    }
                    
                    modelSelect.appendChild(option);
                });
                
                // Show/hide image generation button based on chatbot type
                const imageGenBtn = document.getElementById('image-generation-btn');
                const webSearchBtn = document.getElementById('web-search-btn');
                if (data.chatbot_type === 'image_editing') {
                    // For image editing chatbots:
                    // 1. Hide the image generation button (it's automatic)
                    imageGenBtn.style.display = 'none';
                    // 2. Enable image generation by default
                    sessionStorage.setItem(`imageGen_${currentSessionId}`, 'true');
                    // 3. Hide the web search button
                    webSearchBtn.style.display = 'none';
                } else {
                    // For other chatbots:
                    // 1. Show/hide image generation button based on access
                    imageGenBtn.style.display = 'inline-block';
                    // 2. Restore web search button visibility
                    webSearchBtn.style.display = 'inline-block';
                    // Also disable image generation if it was enabled
                    imageGenBtn.classList.remove('btn-primary');
                    imageGenBtn.classList.add('btn-outline-primary');
                    imageGenBtn.innerHTML = '<i class="fas fa-image"></i> تولید تصویر';
                    imageGenBtn.title = 'فعال کردن تولید تصویر';
                    sessionStorage.setItem(`imageGen_${currentSessionId}`, 'false');
                }
            })
            .catch(error => console.error('Error loading models:', error));
}

    // Add pause functionality variables and functions
    let abortController = new AbortController();

    // تابع برای تغییر وضعیت دکمه
    function setButtonState(isSending) {
        const sendButton = document.getElementById('send-button');
        const sendIcon = sendButton.querySelector('.send-icon');
        const stopIcon = sendButton.querySelector('.stop-icon');

        if (isSending) {
            sendIcon.style.display = 'none';
            stopIcon.style.display = 'inline-block';
            sendButton.classList.add('btn-danger'); // تغییر رنگ به قرمز
            sendButton.onclick = function(event) {
                event.preventDefault();
                abortController.abort(); // لغو درخواست در صورت کلیک
            };
        } else {
            sendIcon.style.display = 'inline-block';
            stopIcon.style.display = 'none';
            sendButton.classList.remove('btn-danger');
            sendButton.onclick = null; // حذف رویداد کلیک قبلی
        }
    }

    // رویداد ترک صفحه
    window.addEventListener('beforeunload', function() {
        // اگر درخواستی در حال پردازش است، آن را لغو کن
        if (abortController && !abortController.signal.aborted) {
            abortController.abort();
        }
    });
</script>
{% endblock %}
